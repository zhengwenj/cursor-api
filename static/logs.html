<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;," />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¯·æ±‚æ—¥å¿—æŸ¥çœ‹</title>
  <!-- å¼•å…¥å…±äº«æ ·å¼ -->
  <link rel="stylesheet" href="/static/shared-styles.css" />
  <script src="/static/shared.js"></script>
  <style>
    /* ç­›é€‰é¢æ¿æ ·å¼ */
    .filter-panel {
      background: var(--card-background);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing);
      border: 1px solid var(--border-color);
    }

    .filter-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .filter-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .filter-section h3 {
      margin: 0 0 15px 0;
      color: var(--primary-color);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .filter-group input[type="datetime-local"],
    .filter-group input[type="text"],
    .filter-group input[type="number"],
    .filter-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background: var(--card-background);
      color: var(--text-primary);
      font-size: 14px;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .range-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .range-input input {
      flex: 1;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    /* åˆ›å»ºæ­£ç¡®çš„å †å ä¸Šä¸‹æ–‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: var(--spacing);
    }

    .stat-card {
      background: var(--card-background);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all var(--transition-fast);
      border: 1px solid var(--border-color);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .stat-card h4 {
      margin: 0 0 8px 0;
      color: var(--primary-color);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 600;
      color: var(--primary-color);
      margin-top: 4px;
    }

    .refresh-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--card-background);
      padding: 8px 16px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      overflow-y: hidden;
    }

    .modal-content {
      background-color: var(--card-background);
      margin: 5% auto;
      padding: 20px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: var(--card-background);
      z-index: 10;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .modal-header h3 {
      margin: 0;
      flex-grow: 1;
    }

    #conversation-content-container {
      flex: 1;
      overflow-y: auto;
      margin: 0 -20px;
      padding: 20px;
    }

    .close {
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      padding: 5px 10px;
    }

    .close:hover {
      color: var(--primary-color);
    }

    .info-button {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: var(--border-radius);
      transition: all var(--transition-fast);
      background: var(--primary-color-alpha);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    .info-button:hover {
      background: var(--primary-color);
      color: white;
    }

    .message-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin: 0;
      border: 1px solid var(--border-color);
    }

    .message-table th,
    .message-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      transition: background-color var(--transition-fast);
    }

    .message-table td {
      word-break: break-word;
    }

    .message-table td:nth-child(2) {
      max-width: 600px;
    }

    .message-table td:first-child {
      width: 80px;
      white-space: nowrap;
    }

    .usage-progress-container {
      margin: 16px 0;
      height: 8px;
      background-color: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }

    .usage-progress-bar {
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
      background-color: var(--primary-color);
      border-radius: 4px;
    }

    .usage-progress-bar.low {
      background-color: #4caf50;
    }

    .usage-progress-bar.medium {
      background-color: #ff9800;
    }

    .usage-progress-bar.high {
      background-color: #f44336;
    }

    /* Token ä¿¡æ¯å’Œå¯¹è¯é¢„è§ˆçš„é€šç”¨æ ·å¼ */
    .token-info-tooltip {
      position: relative;
      display: inline-block;
    }

    .token-info-tooltip .tooltip-content {
      visibility: hidden;
      position: absolute;
      z-index: 1002;
      background-color: var(--card-background);
      color: var(--text-primary);
      padding: 12px 15px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      width: 280px;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(100% + 8px);
      opacity: 0;
      transition:
        opacity 0.3s,
        visibility 0.3s;
      text-align: left;
      line-height: 1.6;
      border: 1px solid var(--border-color);
      pointer-events: none;
    }

    .token-info-tooltip:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }

    .token-info-tooltip .tooltip-content::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -8px;
      border-width: 8px;
      border-style: solid;
      border-color: var(--card-background) transparent transparent transparent;
    }

    .token-info-tooltip::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 100%;
      width: 100%;
      height: 10px;
      background: transparent;
    }

    .token-info-tooltip .tooltip-info-row {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
    }

    .token-info-tooltip .tooltip-info-row .label {
      color: var(--text-secondary);
      margin-right: 10px;
    }

    .token-info-tooltip .tooltip-info-row .value {
      font-weight: 500;
      word-break: break-word;
    }

    .token-info-container {
      flex: 1;
      overflow-y: auto;
      margin: 0 -20px;
      padding: 20px;
    }

    /* å¯¹è¯é¢„è§ˆç‰¹å®šæ ·å¼ */
    .prompt-preview .tooltip-content {
      width: 320px;
      max-height: 200px;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .prompt-preview .tooltip-content .message-meta {
      font-size: 0.8em;
      color: var(--text-secondary);
      padding: 0;
      margin: 0 0 4px 0;
    }

    .prompt-preview .tooltip-content .last-message {
      font-size: 0.9em;
      line-height: 1.5;
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .prompt-preview .tooltip-content::-webkit-scrollbar {
      width: 6px;
    }

    .prompt-preview .tooltip-content::-webkit-scrollbar-thumb {
      background-color: var(--border-color);
      border-radius: 3px;
    }

    .prompt-preview .tooltip-content::-webkit-scrollbar-track {
      background-color: var(--card-background);
    }

    /* ä¼˜åŒ–è¡¨æ ¼æ ·å¼ */
    .table-container {
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    #logsTable {
      position: relative;
      z-index: 1;
    }

    #logsTable th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--primary-color);
      white-space: nowrap;
      transition: background-color 0.2s ease;
    }

    #logsTable td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      transition: background-color var(--transition-fast);
    }

    #logsTable tr:hover td {
      background-color: var(--hover-color, rgba(0, 0, 0, 0.02));
    }

    .modal-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .danger-button {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: var(--border-radius);
      background: var(--error-color-alpha);
      color: var(--error-color);
      border: 1px solid var(--error-color);
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-right: 8px;
    }

    .danger-button:hover {
      background: var(--error-color);
      color: white;
    }

    .warning-button {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: var(--border-radius);
      background: rgba(255, 193, 7, 0.1);
      color: #e8a400;
      border: 1px solid #e8a400;
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-right: 8px;
    }

    .warning-button:hover {
      background: #e8a400;
      color: white;
    }

    .success-button {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: var(--border-radius);
      background: rgba(76, 175, 80, 0.1);
      color: #4caf50;
      border: 1px solid #4caf50;
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-right: 8px;
    }

    .success-button:hover {
      background: #4caf50;
      color: white;
    }

    /* å›¾è¡¨æ ·å¼ */
    .chart-container {
      background: var(--card-background);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing);
      border: 1px solid var(--border-color);
      height: 300px;
    }

    /* æ·»åŠ èœå•åˆ‡æ¢æ ·å¼ */
    .tab-menu {
      display: flex;
      margin-bottom: 15px;
    }

    .tab-button {
      padding: 8px 16px;
      background: var(--card-background);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: 14px;
    }

    .tab-button:first-child {
      border-radius: var(--border-radius) 0 0 var(--border-radius);
    }

    .tab-button:last-child {
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }

    .tab-button.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .delay-chart-container {
      height: 200px;
      margin-bottom: 20px;
    }

    .delay-table-container {
      max-height: none;
      overflow-y: visible;
    }

    .pagination-container {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pagination-info {
      flex: 1;
    }

    .pagination-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .page-jumper {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 15px;
    }

    .page-input {
      width: 60px;
      padding: 5px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .page-input:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .page-go-btn {
      padding: 5px 10px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: var(--card-background);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .page-go-btn:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* å“åº”å¼æ ·å¼ */
    @media (max-width: 768px) {
      .filter-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .stat-card {
        padding: 16px;
      }

      .stat-value {
        font-size: 24px;
      }

      .modal-content {
        margin: 2% auto;
        width: 95%;
        padding: 16px;
      }

      .chart-container {
        height: 200px;
        padding: 16px;
      }

      .modal-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .tab-menu {
        width: 100%;
      }

      .tab-button {
        flex: 1;
      }
    }
  </style>
</head>

<body>
  <h1>è¯·æ±‚æ—¥å¿—æŸ¥çœ‹</h1>

  <div class="container">
    <div class="form-group">
      <label>è®¤è¯ä»¤ç‰Œ:</label>
      <input type="password" id="authToken" placeholder="è¾“å…¥ AUTH_TOKEN" />
    </div>

    <!-- æ–°çš„ç­›é€‰é¢æ¿ -->
    <div class="filter-panel">
      <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
      <div class="filter-section">
        <h3>ğŸ“… æ—¶é—´èŒƒå›´</h3>
        <div class="filter-grid">
          <div class="filter-group">
            <label for="fromDate">å¼€å§‹æ—¶é—´</label>
            <input type="datetime-local" id="fromDate" />
          </div>
          <div class="filter-group">
            <label for="toDate">ç»“æŸæ—¶é—´</label>
            <input type="datetime-local" id="toDate" />
          </div>
        </div>
        <div style="margin-top: 10px">
          <label
            style="
              display: block;
              margin-bottom: 5px;
              font-size: 13px;
              color: var(--text-secondary);
            "
            >å¿«é€Ÿé€‰æ‹©</label
          >
          <div class="button-group" style="justify-content: flex-start">
            <button
              onclick="setTimeRange('1h')"
              style="padding: 6px 12px; font-size: 14px"
            >
              æœ€è¿‘1å°æ—¶
            </button>
            <button
              onclick="setTimeRange('24h')"
              style="padding: 6px 12px; font-size: 14px"
            >
              æœ€è¿‘24å°æ—¶
            </button>
            <button
              onclick="setTimeRange('7d')"
              style="padding: 6px 12px; font-size: 14px"
            >
              æœ€è¿‘7å¤©
            </button>
            <button
              onclick="setTimeRange('30d')"
              style="padding: 6px 12px; font-size: 14px"
            >
              æœ€è¿‘30å¤©
            </button>
          </div>
        </div>
      </div>

      <!-- ç”¨æˆ·ç­›é€‰ -->
      <div class="filter-section">
        <h3>ğŸ‘¤ ç”¨æˆ·ç­›é€‰</h3>
        <div class="filter-grid">
          <div class="filter-group">
            <label for="userId">ç”¨æˆ·ID</label>
            <input type="text" id="userId" placeholder="ç²¾ç¡®åŒ¹é…ç”¨æˆ·ID" />
          </div>
          <div class="filter-group">
            <label for="email">é‚®ç®±</label>
            <input type="text" id="email" placeholder="æ”¯æŒéƒ¨åˆ†åŒ¹é…" />
          </div>
          <div class="filter-group">
            <label for="membershipType">ä¼šå‘˜ç±»å‹</label>
            <select id="membershipType">
              <option value="">å…¨éƒ¨</option>
              <option value="free">å…è´¹</option>
              <option value="free_trial">è¯•ç”¨</option>
              <option value="pro">ä¸“ä¸šç‰ˆ</option>
              <option value="enterprise">ä¼ä¸šç‰ˆ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- æ¨¡å‹ç­›é€‰ -->
      <div class="filter-section">
        <h3>ğŸ¤– æ¨¡å‹ç­›é€‰</h3>
        <div class="filter-grid">
          <div class="filter-group">
            <label for="model">æ¨¡å‹åç§°</label>
            <input type="text" id="model" placeholder="æ”¯æŒéƒ¨åˆ†åŒ¹é…" />
          </div>
          <div class="filter-group">
            <label for="includeModels">åŒ…å«æ¨¡å‹</label>
            <input
              type="text"
              id="includeModels"
              placeholder="é€—å·åˆ†éš”ï¼Œå¦‚: gpt-4,claude"
            />
          </div>
          <div class="filter-group">
            <label for="excludeModels">æ’é™¤æ¨¡å‹</label>
            <input
              type="text"
              id="excludeModels"
              placeholder="é€—å·åˆ†éš”ï¼Œå¦‚: gpt-3.5,dall-e"
            />
          </div>
        </div>
      </div>

      <!-- æ€§èƒ½ç­›é€‰ -->
      <div class="filter-section">
        <h3>ğŸ“Š æ€§èƒ½ç­›é€‰</h3>
        <div class="filter-grid">
          <div class="filter-group">
            <label>è€—æ—¶èŒƒå›´ï¼ˆç§’ï¼‰</label>
            <div class="range-input">
              <input
                type="number"
                id="minTotalTime"
                placeholder="æœ€å°"
                step="0.1"
                min="0"
              />
              <span>~</span>
              <input
                type="number"
                id="maxTotalTime"
                placeholder="æœ€å¤§"
                step="0.1"
                min="0"
              />
            </div>
          </div>
          <div class="filter-group">
            <label>TokensèŒƒå›´</label>
            <div class="range-input">
              <input
                type="number"
                id="minTokens"
                placeholder="æœ€å°"
                min="0"
              />
              <span>~</span>
              <input
                type="number"
                id="maxTokens"
                placeholder="æœ€å¤§"
                min="0"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- å…¶ä»–é€‰é¡¹ -->
      <div class="filter-section">
        <h3>ğŸ”§ å…¶ä»–é€‰é¡¹</h3>
        <div class="filter-grid">
          <div class="filter-group">
            <label for="status">çŠ¶æ€</label>
            <select id="status">
              <option value="">å…¨éƒ¨</option>
              <option value="pending">å¤„ç†ä¸­</option>
              <option value="success">æˆåŠŸ</option>
              <option value="failure">å¤±è´¥</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="stream">æµå¼å“åº”</label>
            <select id="stream">
              <option value="">å…¨éƒ¨</option>
              <option value="true">æ˜¯</option>
              <option value="false">å¦</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="hasError">åŒ…å«é”™è¯¯</label>
            <select id="hasError">
              <option value="">å…¨éƒ¨</option>
              <option value="true">æ˜¯</option>
              <option value="false">å¦</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="hasChain">åŒ…å«å¯¹è¯</label>
            <select id="hasChain">
              <option value="">å…¨éƒ¨</option>
              <option value="true">æ˜¯</option>
              <option value="false">å¦</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="hasUsage">åŒ…å«ç”¨é‡</label>
            <select id="hasUsage">
              <option value="">å…¨éƒ¨</option>
              <option value="true">æ˜¯</option>
              <option value="false">å¦</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="reverse">æ’åºæ–¹å¼</label>
            <select id="reverse">
              <option value="false">ä»æ—§åˆ°æ–°</option>
              <option value="true">ä»æ–°åˆ°æ—§</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="pageSize">æ¯é¡µæ˜¾ç¤º</label>
            <select id="pageSize">
              <option value="10">10 æ¡</option>
              <option value="20" selected>20 æ¡</option>
              <option value="50">50 æ¡</option>
              <option value="100">100 æ¡</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="errorText">é”™è¯¯ä¿¡æ¯</label>
            <input type="text" id="errorText" placeholder="æ”¯æŒéƒ¨åˆ†åŒ¹é…" />
          </div>
        </div>
      </div>

      <!-- ç­›é€‰æ“ä½œæŒ‰é’® -->
      <div class="filter-actions">
        <button onclick="resetFilters()">é‡ç½®</button>
        <button onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
      </div>
    </div>

    <div class="refresh-container">
      <div class="button-group">
        <button onclick="fetchLogs()">åˆ·æ–°æ—¥å¿—</button>
        <button onclick="exportLogs()" style="margin-left: 10px">
          å¯¼å‡ºæ•°æ®
        </button>
      </div>
      <div class="auto-refresh">
        <input type="checkbox" id="autoRefresh" checked />
        <label for="autoRefresh">è‡ªåŠ¨åˆ·æ–° (60ç§’)</label>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="stats-grid">
      <div class="stat-card">
        <h4>æ€»è¯·æ±‚æ•°</h4>
        <div id="totalRequests" class="stat-value">-</div>
      </div>
      <div class="stat-card">
        <h4>æˆåŠŸè¯·æ±‚</h4>
        <div id="successRequests" class="stat-value">-</div>
      </div>
      <div class="stat-card">
        <h4>å¤±è´¥è¯·æ±‚</h4>
        <div id="failureRequests" class="stat-value">-</div>
      </div>
      <div class="stat-card">
        <h4>æœ€åæ›´æ–°</h4>
        <div id="lastUpdate" class="stat-value">-</div>
      </div>
    </div>

    <!-- æ·»åŠ å›¾è¡¨å®¹å™¨ -->
    <div class="chart-container">
      <canvas id="requestsChart"></canvas>
    </div>

    <div class="table-container">
      <table id="logsTable">
        <thead>
          <tr>
            <th>åºå·</th>
            <th>æ—¶é—´</th>
            <th>æ¨¡å‹</th>
            <th>Tokenä¿¡æ¯</th>
            <th>å¯¹è¯</th>
            <th>ç”¨æ—¶</th>
            <th>è¾“å…¥/è¾“å‡º</th>
            <th>æµå¼</th>
            <th>çŠ¶æ€</th>
            <th>é”™è¯¯ä¿¡æ¯</th>
          </tr>
        </thead>
        <tbody id="logsBody"></tbody>
      </table>
    </div>

    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="pagination-container">
      <div class="pagination-info">
        å…± <span id="totalRecords">0</span> æ¡è®°å½•ï¼Œ æ¯é¡µ
        <input
          type="number"
          id="customPageSize"
          class="page-input"
          min="5"
          max="100"
          value="20"
        />
        æ¡
        <button class="page-go-btn" onclick="changePageSize()">åº”ç”¨</button>
      </div>
      <div class="pagination-controls">
        <button id="prevPage" onclick="changePage(-1)" disabled>
          &laquo; ä¸Šä¸€é¡µ
        </button>
        <span id="currentPage">ç¬¬ 1 é¡µ</span>
        <button id="nextPage" onclick="changePage(1)" disabled>
          ä¸‹ä¸€é¡µ &raquo;
        </button>
        <div class="page-jumper">
          è·³è½¬åˆ°ç¬¬
          <input
            type="number"
            id="pageNumberInput"
            class="page-input"
            min="1"
            value="1"
          />
          é¡µ
          <button class="page-go-btn" onclick="jumpToPage()">GO</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tokenè¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="tokenModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Token è¯¦ç»†ä¿¡æ¯</h3>
        <span class="close">&times;</span>
      </div>
      <div class="token-info-container">
        <table class="message-table">
          <tbody>
            <tr>
              <td>Token</td>
              <td id="modalToken">-</td>
            </tr>
            <tr>
              <td>Checksum</td>
              <td id="modalChecksum">-</td>
            </tr>
            <tr>
              <td>Client Key</td>
              <td id="modalClientKey">-</td>
            </tr>
            <tr>
              <td>Config Version</td>
              <td id="modalConfigVersion">-</td>
            </tr>
            <tr>
              <td>Session ID</td>
              <td id="modalSessionId">-</td>
            </tr>
            <tr>
              <td>Proxy</td>
              <td id="modalProxy">-</td>
            </tr>
            <tr>
              <td>Timezone</td>
              <td id="modalTimezone">-</td>
            </tr>
            <tr>
              <td>Email</td>
              <td id="modalEmail">-</td>
            </tr>
            <tr>
              <td>Name</td>
              <td id="modalName">-</td>
            </tr>
            <tr>
              <td>Updated At</td>
              <td id="modalUpdatedAt">-</td>
            </tr>
            <tr>
              <td>Member Type</td>
              <td id="modalMemberType">-</td>
            </tr>
            <tr>
              <td>Payment ID</td>
              <td id="modalPaymentId">-</td>
            </tr>
            <tr>
              <td>Trial Days</td>
              <td id="modalTrialDays">-</td>
            </tr>
          </tbody>
        </table>
        <div id="usageProgressContainer"></div>
      </div>
    </div>
  </div>

  <!-- å¯¹è¯è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="conversationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>å¯¹è¯è¯¦æƒ…</h3>
        <div class="tab-menu">
          <button id="tab-prompt" class="tab-button active">å¯¹è¯å†…å®¹</button>
          <button id="tab-think" class="tab-button">æ€è€ƒè¿‡ç¨‹</button>
          <button id="tab-delays" class="tab-button">å»¶è¿Ÿåˆ†æ</button>
        </div>
        <span class="close">&times;</span>
      </div>
      <div id="conversation-content-container">
        <div id="dialogContent" class="tab-content active"></div>
        <div id="thinkContent" class="tab-content">
          <pre id="thinkText"></pre>
        </div>
        <div id="delaysContent" class="tab-content">
          <div class="delay-chart-container">
            <canvas id="delayChart"></canvas>
          </div>
          <div class="delay-table-container">
            <table id="delaysTable" class="message-table">
              <thead>
                <tr>
                  <th>åºå·</th>
                  <th>æ–‡æœ¬å—</th>
                  <th>å»¶è¿Ÿæ—¶é—´(s)</th>
                  <th>é€Ÿç‡(å­—ç¬¦/ç§’)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¼•å…¥Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

  <script>
    // å…¨å±€å˜é‡
    let currentPageIndex = 0;
    let pageSize = 20;
    let totalRecords = 0;
    let currentFilters = {};
    let refreshInterval = null;
    let requestsChart = null;

    // åˆå§‹åŒ–å˜é‡
    let currentTokenDetails = {};

    // Tokenä¿¡æ¯ç¼“å­˜
    let tokenInfoCache = {};
    let allTokensLoaded = false; // æ ‡è®°æ˜¯å¦å·²åŠ è½½æ‰€æœ‰tokenä¿¡æ¯

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(data) {
      // è®¡ç®—å„ç§ç»Ÿè®¡
      const totalRequests = data.total || 0;
      const successRequests = data.logs.filter(
        (log) => log.status === "success",
      ).length;
      const failureRequests = data.logs.filter(
        (log) => log.status === "failure",
      ).length;

      // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
      document.getElementById("totalRequests").textContent =
        totalRequests.toLocaleString();
      document.getElementById("successRequests").textContent =
        successRequests.toLocaleString();
      document.getElementById("failureRequests").textContent =
        failureRequests.toLocaleString();
      document.getElementById("lastUpdate").textContent =
        new Date().toLocaleTimeString("zh-CN");
    }

    // æ˜¾ç¤ºTokenè¯¦æƒ…æ¨¡æ€æ¡†
    async function showTokenModal(tokenInfo) {
      const modal = document.getElementById("tokenModal");

      // å¦‚æœæœ‰keyï¼Œä¼˜å…ˆä»ç¼“å­˜è·å–è¯¦ç»†ä¿¡æ¯
      if (tokenInfo.key && tokenInfoCache[tokenInfo.key]) {
        // ä½¿ç”¨ç¼“å­˜çš„æ•°æ®
        tokenInfo = { ...tokenInfo, ...tokenInfoCache[tokenInfo.key] };
      }

      // è®¾ç½®åŸºç¡€ä¿¡æ¯
      document.getElementById("modalToken").textContent =
        tokenInfo.primary_token || "-";

      // å¤„ç†checksum
      if (tokenInfo.checksum) {
        document.getElementById("modalChecksum").textContent = `${
          tokenInfo.checksum.first || "-"
        } / ${tokenInfo.checksum.second || "-"}`;
      } else {
        document.getElementById("modalChecksum").textContent = "-";
      }

      // è®¾ç½®å…¶ä»–å­—æ®µ
      document.getElementById("modalClientKey").textContent =
        tokenInfo.client_key || "-";
      document.getElementById("modalConfigVersion").textContent =
        tokenInfo.config_version || "-";
      document.getElementById("modalSessionId").textContent =
        tokenInfo.session_id || "-";
      document.getElementById("modalProxy").textContent =
        tokenInfo.proxy || "-";
      document.getElementById("modalTimezone").textContent =
        tokenInfo.timezone || "-";

      // å¤„ç†ç”¨æˆ·ä¿¡æ¯
      if (tokenInfo.user) {
        document.getElementById("modalEmail").textContent =
          tokenInfo.user.email || "-";
        document.getElementById("modalName").textContent =
          tokenInfo.user.name || "-";
        document.getElementById("modalUpdatedAt").textContent = tokenInfo.user
          .updated_at
          ? new Date(tokenInfo.user.updated_at).toLocaleString()
          : "-";
      } else {
        document.getElementById("modalEmail").textContent = "-";
        document.getElementById("modalName").textContent = "-";
        document.getElementById("modalUpdatedAt").textContent = "-";
      }

      // å¤„ç†Stripeä¿¡æ¯
      if (tokenInfo.stripe) {
        document.getElementById("modalMemberType").textContent =
          formatMembershipType(tokenInfo.stripe.membership_type);
        document.getElementById("modalPaymentId").textContent =
          tokenInfo.stripe.payment_id || "-";
        document.getElementById("modalTrialDays").textContent =
          tokenInfo.stripe.days_remaining_on_trial > 0
            ? `${tokenInfo.stripe.days_remaining_on_trial}å¤©`
            : "-";
      } else {
        document.getElementById("modalMemberType").textContent = "-";
        document.getElementById("modalPaymentId").textContent = "-";
        document.getElementById("modalTrialDays").textContent = "-";
      }

      // å¤„ç†ä½¿ç”¨é‡ä¿¡æ¯
      const container = document.getElementById("usageProgressContainer");
      container.innerHTML = "";

      if (tokenInfo.usage) {
        const models = {
          Premium: tokenInfo.usage.premium,
          Standard: tokenInfo.usage.standard,
        };

        Object.entries(models).forEach(([modelName, modelData]) => {
          if (modelData) {
            const div = document.createElement("div");
            div.style.marginTop = "10px";

            const label = document.createElement("strong");
            label.textContent = `${modelName} ä½¿ç”¨é‡: `;
            div.appendChild(label);

            const text = document.createElement("span");
            if (modelData.max_requests) {
              const percentage = (
                (modelData.num_requests / modelData.max_requests) *
                100
              ).toFixed(1);
              text.textContent = `${modelData.num_requests}/${modelData.max_requests} è¯·æ±‚ (${percentage}%), ${modelData.num_tokens} tokens`;

              const progressDiv = document.createElement("div");
              progressDiv.className = "usage-progress-container";
              const colorClass =
                percentage < 50 ? "low" : percentage < 80 ? "medium" : "high";
              progressDiv.innerHTML = `<div class="usage-progress-bar ${colorClass}" style="width: ${percentage}%"></div>`;
              div.appendChild(text);
              div.appendChild(progressDiv);
            } else {
              text.textContent = `${modelData.num_requests} è¯·æ±‚, ${modelData.num_tokens} tokens`;
              div.appendChild(text);
            }

            container.appendChild(div);
          }
        });
      }

      modal.style.display = "block";
    }

    // æ ¼å¼åŒ–ç®€å•Tokenä¿¡æ¯ç”¨äºtooltip
    function formatSimpleTokenInfo(tokenInfo) {
      if (!tokenInfo) return "æ— Tokenä¿¡æ¯";

      // å¦‚æœæœ‰keyï¼Œä¼˜å…ˆä»ç¼“å­˜è·å–å®Œæ•´ä¿¡æ¯
      let fullTokenInfo = tokenInfo;
      if (tokenInfo.key && tokenInfoCache[tokenInfo.key]) {
        fullTokenInfo = { ...tokenInfo, ...tokenInfoCache[tokenInfo.key] };
      }

      const rows = [];

      if (fullTokenInfo.key) {
        rows.push(["Key", fullTokenInfo.key]);
      }

      if (fullTokenInfo.user) {
        rows.push(["é‚®ç®±", fullTokenInfo.user.email || "-"]);
        if (fullTokenInfo.user.name) {
          rows.push(["ç”¨æˆ·å", fullTokenInfo.user.name]);
        }
      }

      if (fullTokenInfo.stripe) {
        rows.push([
          "ä¼šå‘˜ç±»å‹",
          formatMembershipType(fullTokenInfo.stripe.membership_type),
        ]);
      }

      if (fullTokenInfo.usage?.premium) {
        const premium = fullTokenInfo.usage.premium;
        const usage = premium.max_requests
          ? `${premium.num_requests}/${premium.max_requests}`
          : `${premium.num_requests}`;
        rows.push(["Premiumä½¿ç”¨", usage]);
      }

      if (rows.length === 0) {
        return "æ— è¯¦ç»†ä¿¡æ¯";
      }

      return rows
        .map(
          ([label, value]) =>
            `<div class="tooltip-info-row"><span class="label">${label}:</span><span class="value">${value}</span></div>`,
        )
        .join("");
    }

    // è®¾ç½®æ—¶é—´èŒƒå›´å¿«é€Ÿé€‰æ‹©
    function setTimeRange(range) {
      const now = new Date();
      const toDate = now.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
      let fromDate;

      switch (range) {
        case "1h":
          fromDate = new Date(now - 60 * 60 * 1000)
            .toISOString()
            .slice(0, 16);
          break;
        case "24h":
          fromDate = new Date(now - 24 * 60 * 60 * 1000)
            .toISOString()
            .slice(0, 16);
          break;
        case "7d":
          fromDate = new Date(now - 7 * 24 * 60 * 60 * 1000)
            .toISOString()
            .slice(0, 16);
          break;
        case "30d":
          fromDate = new Date(now - 30 * 24 * 60 * 60 * 1000)
            .toISOString()
            .slice(0, 16);
          break;
      }

      document.getElementById("fromDate").value = fromDate;
      document.getElementById("toDate").value = toDate;

      // è‡ªåŠ¨åº”ç”¨ç­›é€‰
      applyFilters();
    }

    function initChart() {
      const ctx = document.getElementById("requestsChart").getContext("2d");
      requestsChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "æ¯å°æ—¶è¯·æ±‚æ•°",
              data: [],
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 10,
              },
            },
          },
          plugins: {
            title: {
              display: true,
              text: "24å°æ—¶è¯·æ±‚ç»Ÿè®¡",
            },
          },
        },
      });
    }

    // æ›´æ–°å›¾è¡¨æ•°æ®
    function updateChart(data) {
      if (!requestsChart) {
        initChart();
      }

      // æŒ‰å°æ—¶ç»Ÿè®¡è¯·æ±‚æ•°é‡
      const hourlyStats = new Map();
      const now = new Date();
      const past24Hours = new Date(now - 24 * 60 * 60 * 1000);

      // åˆå§‹åŒ–24å°æ—¶çš„æ—¶é—´æ®µ
      for (let i = 0; i < 24; i++) {
        const hour = new Date(now - i * 60 * 60 * 1000);
        const hourKey = hour.toLocaleString("zh-CN", {
          month: "numeric",
          day: "numeric",
          hour: "numeric",
        });
        hourlyStats.set(hourKey, 0);
      }

      // ç»Ÿè®¡æ¯å°æ—¶çš„è¯·æ±‚æ•°
      data.logs.forEach((log) => {
        const logTime = new Date(log.timestamp);
        if (logTime >= past24Hours) {
          const hourKey = logTime.toLocaleString("zh-CN", {
            month: "numeric",
            day: "numeric",
            hour: "numeric",
          });
          if (hourlyStats.has(hourKey)) {
            hourlyStats.set(hourKey, hourlyStats.get(hourKey) + 1);
          }
        }
      });

      // è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®
      const sortedHours = Array.from(hourlyStats.keys()).reverse();
      const counts = sortedHours.map((hour) => hourlyStats.get(hour));

      requestsChart.data.labels = sortedHours;
      requestsChart.data.datasets[0].data = counts;
      requestsChart.update();
    }

    async function updateTable(data) {
      const tbody = document.getElementById("logsBody");
      updateStats(data);
      updateChart(data);

      // æ›´æ–°æ€»è®°å½•æ•°å’Œåˆ†é¡µä¿¡æ¯
      totalRecords = data.total;
      document.getElementById("totalRecords").textContent = totalRecords;
      updatePaginationControls();

      // æ”¶é›†æ‰€æœ‰çš„token keys
      const tokenKeys = new Set();
      data.logs.forEach((log) => {
        if (log.token_info && log.token_info.key) {
          tokenKeys.add(log.token_info.key);
        }
      });

      // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡æ‰€æœ‰tokenä¿¡æ¯ï¼Œåˆ™åŠ è½½å¹¶ç­‰å¾…å®Œæˆ
      if (!allTokensLoaded && tokenKeys.size > 0) {
        await loadAllTokenInfo(Array.from(tokenKeys));
      }

      tbody.innerHTML = data.logs
        .map((log) => {
          // å‡†å¤‡æ•°æ®å±æ€§
          let attributes = {};

          // å¤„ç† prompt å±æ€§
          if (log.chain && typeof log.chain.prompt === "string") {
            try {
              const promptJson = JSON.stringify(log.chain.prompt);
              const escapedPrompt = escapeHtml(promptJson);
              attributes.prompt = `data-prompt='${escapedPrompt}'`;
            } catch (e) {
              console.error(
                "Failed to process prompt data:",
                e,
                log.chain.prompt,
              );
            }
          }

          // å¤„ç† think å±æ€§
          if (log.chain && typeof log.chain.think === "string") {
            try {
              const thinkJson = JSON.stringify(log.chain.think);
              const escapedThink = escapeHtml(thinkJson);
              attributes.think = `data-think='${escapedThink}'`;
            } catch (e) {
              console.error(
                "Failed to process think data:",
                e,
                log.chain.think,
              );
            }
          }

          // å¤„ç† delays å±æ€§
          if (
            log.chain &&
            Array.isArray(log.chain.delays) &&
            log.chain.delays.length === 2 &&
            typeof log.chain.delays[0] === "string" &&
            Array.isArray(log.chain.delays[1])
          ) {
            try {
              const delaysJson = JSON.stringify(log.chain.delays);
              const escapedDelays = escapeHtml(delaysJson);
              attributes.delays = `data-delays='${escapedDelays}'`;
            } catch (e) {
              console.error(
                "Failed to stringify delays data:",
                e,
                log.chain.delays,
              );
            }
          }

          // ç»„åˆæ‰€æœ‰å±æ€§
          const allAttributes = Object.values(attributes).join(" ");

          return `<tr>
    <td>${log.id}</td>
    <td>${new Date(log.timestamp).toLocaleString()}</td>
    <td>${log.model}</td>
    <td><div class="token-info-tooltip"><button class="info-button" onclick='showTokenModal(${JSON.stringify(
      log.token_info,
    )})'>æŸ¥çœ‹è¯¦æƒ…<div class="tooltip-content">${formatSimpleTokenInfo(
      log.token_info,
    )}</div></button></div></td>
    <td>${
      log.chain
        ? `<div class="token-info-tooltip prompt-preview"><button class="info-button view-conversation" ${allAttributes}>æŸ¥çœ‹å¯¹è¯<div class="tooltip-content">${formatDialogPreview(
            JSON.stringify(log.chain.prompt || ""),
          )}</div></button></div>`
        : "-"
    }</td>
    <td>${formatTiming(log.timing.total)}</td>
    <td>${formatUsage(log.chain?.usage)}</td>
    <td>${log.stream ? "æ˜¯" : "å¦"}</td>
    <td>${log.status}</td>
    <td>${
      typeof log.error === "string" ? log.error : (log.error?.error ?? "-")
    }</td>
  </tr>`;
        })
        .join("");

      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      tbody.querySelectorAll(".view-conversation").forEach((button) => {
        button.addEventListener("click", function () {
          const prompt = this.hasAttribute("data-prompt")
            ? JSON.parse(this.dataset.prompt)
            : "";
          const think = this.hasAttribute("data-think")
            ? JSON.parse(this.dataset.think)
            : "";
          const delays = this.hasAttribute("data-delays")
            ? JSON.parse(this.dataset.delays)
            : [];

          showConversationModal(prompt, think, delays);
        });
      });
    }

    function formatTiming(total) {
      return `${total.toFixed(2)}s`;
    }

    function formatDialogPreview(promptStr) {
      try {
        const messages = parsePrompt(promptStr);
        if (!messages || messages.length === 0) {
          return "æ— å¯¹è¯å†…å®¹";
        }

        // è·å–æœ€åä¸€æ¡æ¶ˆæ¯
        const lastMessage = messages[messages.length - 1];
        const roleLabels = {
          system: "ç³»ç»Ÿ",
          user: "ç”¨æˆ·",
          assistant: "åŠ©æ‰‹",
        };

        return `<div class="message-meta">æœ€åä¸€æ¡æ¶ˆæ¯ (${
          roleLabels[lastMessage.role] || lastMessage.role
        }):</div><div class="last-message">${lastMessage.content
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\n/g, "<br>")}</div>`;
      } catch (e) {
        console.error("é¢„è§ˆå¯¹è¯å†…å®¹å¤±è´¥:", e);
        return "æ— æ³•è§£æå¯¹è¯å†…å®¹";
      }
    }

    // æ›´æ–°åˆ†é¡µæ§ä»¶çŠ¶æ€
    function updatePaginationControls() {
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");
      const currentPageSpan = document.getElementById("currentPage");
      const pageNumberInput = document.getElementById("pageNumberInput");
      const customPageSize = document.getElementById("customPageSize");

      // è®¡ç®—æ€»é¡µæ•°
      const totalPages = Math.ceil(totalRecords / pageSize) || 1;

      // ç¦ç”¨æˆ–å¯ç”¨ä¸Šä¸€é¡µæŒ‰é’®
      prevPageBtn.disabled = currentPageIndex <= 0;

      // ç¦ç”¨æˆ–å¯ç”¨ä¸‹ä¸€é¡µæŒ‰é’®ï¼ˆå¦‚æœå½“å‰é¡µæ˜¯æœ€åä¸€é¡µæˆ–æ²¡æœ‰è¶³å¤Ÿçš„è®°å½•ï¼‰
      const hasMorePages = (currentPageIndex + 1) * pageSize < totalRecords;
      nextPageBtn.disabled = !hasMorePages;

      // æ›´æ–°å½“å‰é¡µæ˜¾ç¤º
      currentPageSpan.textContent = `ç¬¬ ${
        currentPageIndex + 1
      } é¡µ / å…± ${totalPages} é¡µ`;

      // åŒæ­¥è¾“å…¥æ¡†æ•°å€¼
      pageNumberInput.value = currentPageIndex + 1;
      pageNumberInput.max = totalPages;
      customPageSize.value = pageSize;
    }

    // åˆ‡æ¢é¡µç 
    function changePage(delta) {
      currentPageIndex += delta;
      if (currentPageIndex < 0) currentPageIndex = 0;

      fetchLogs();
    }

    // è·³è½¬åˆ°æŒ‡å®šé¡µ
    function jumpToPage() {
      const pageNumberInput = document.getElementById("pageNumberInput");
      const pageNumber = parseInt(pageNumberInput.value);
      const totalPages = Math.ceil(totalRecords / pageSize) || 1;

      if (isNaN(pageNumber) || pageNumber < 1) {
        showGlobalMessage("è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ", true);
        pageNumberInput.value = currentPageIndex + 1;
        return;
      }

      if (pageNumber > totalPages) {
        showGlobalMessage(`é¡µç è¶…å‡ºèŒƒå›´ï¼Œæœ€å¤§é¡µç ä¸º ${totalPages}`, true);
        pageNumberInput.value = totalPages;
        return;
      }

      currentPageIndex = pageNumber - 1;
      fetchLogs();
    }

    // æ›´æ”¹æ¯é¡µæ˜¾ç¤ºæ•°é‡
    function changePageSize() {
      const customPageSize = document.getElementById("customPageSize");
      const newPageSize = parseInt(customPageSize.value);

      if (isNaN(newPageSize) || newPageSize < 5 || newPageSize > 100) {
        showGlobalMessage("æ¯é¡µæ˜¾ç¤ºæ•°é‡å¿…é¡»åœ¨5-100ä¹‹é—´", true);
        customPageSize.value = pageSize;
        return;
      }

      // é‡ç½®åˆ°ç¬¬ä¸€é¡µå¹¶ä½¿ç”¨æ–°çš„pageSize
      currentPageIndex = 0;
      pageSize = newPageSize;
      fetchLogs();
    }

    // è·å–æ—¶é—´èŒƒå›´ç­›é€‰
    function getTimeRangeFilter() {
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;

      const filter = {};

      if (fromDate) {
        // è½¬æ¢ä¸ºRFC3339æ ¼å¼
        filter.from_date = new Date(fromDate).toISOString();
      }

      if (toDate) {
        filter.to_date = new Date(toDate).toISOString();
      }

      return filter;
    }

    // è·å–ç”¨æˆ·ç­›é€‰
    function getUserFilter() {
      const filter = {};

      const userId = document.getElementById("userId").value.trim();
      if (userId) filter.user_id = userId;

      const email = document.getElementById("email").value.trim();
      if (email) filter.email = email;

      const membership = document.getElementById("membershipType").value;
      if (membership) filter.membership_type = membership;

      return filter;
    }

    // è·å–æ¨¡å‹ç­›é€‰
    function getModelFilter() {
      const filter = {};

      const model = document.getElementById("model").value.trim();
      if (model) filter.model = model;

      const includeModels = document
        .getElementById("includeModels")
        .value.trim();
      if (includeModels) {
        filter.include_models = includeModels
          .split(",")
          .map((m) => m.trim())
          .filter((m) => m);
      }

      const excludeModels = document
        .getElementById("excludeModels")
        .value.trim();
      if (excludeModels) {
        filter.exclude_models = excludeModels
          .split(",")
          .map((m) => m.trim())
          .filter((m) => m);
      }

      return filter;
    }

    // è·å–æ€§èƒ½ç­›é€‰
    function getPerformanceFilter() {
      const filter = {};

      const minTime = parseFloat(
        document.getElementById("minTotalTime").value,
      );
      if (!isNaN(minTime)) filter.min_total_time = minTime;

      const maxTime = parseFloat(
        document.getElementById("maxTotalTime").value,
      );
      if (!isNaN(maxTime)) filter.max_total_time = maxTime;

      const minTokens = parseInt(document.getElementById("minTokens").value);
      if (!isNaN(minTokens)) filter.min_tokens = minTokens;

      const maxTokens = parseInt(document.getElementById("maxTokens").value);
      if (!isNaN(maxTokens)) filter.max_tokens = maxTokens;

      return filter;
    }

    // è·å–å…¶ä»–ç­›é€‰
    function getOtherFilters() {
      const filter = {};

      const status = document.getElementById("status").value;
      if (status) filter.status = status;

      const stream = document.getElementById("stream").value;
      if (stream) filter.stream = stream === "true";

      const hasError = document.getElementById("hasError").value;
      if (hasError) filter.has_error = hasError === "true";

      const hasChain = document.getElementById("hasChain").value;
      if (hasChain) filter.has_chain = hasChain === "true";

      const hasUsage = document.getElementById("hasUsage").value;
      if (hasUsage) filter.has_usage = hasUsage === "true";

      const error = document.getElementById("errorText").value.trim();
      if (error) filter.error = error;

      return filter;
    }

    // åº”ç”¨ç­›é€‰æ¡ä»¶
    function applyFilters() {
      // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      currentPageIndex = 0;

      // æ›´æ–°æ¯é¡µæ˜¾ç¤ºæ•°é‡
      const pageSizeSelect = document.getElementById("pageSize");
      if (pageSizeSelect) {
        pageSize = parseInt(pageSizeSelect.value);
        // åŒæ­¥è‡ªå®šä¹‰è¾“å…¥æ¡†
        document.getElementById("customPageSize").value = pageSize;
      }

      // è·å–ç­›é€‰åçš„æ•°æ®
      fetchLogs();
    }

    // é‡ç½®ç­›é€‰æ¡ä»¶
    function resetFilters() {
      // é‡ç½®æ‰€æœ‰è¾“å…¥æ¡†
      document.getElementById("fromDate").value = "";
      document.getElementById("toDate").value = "";
      document.getElementById("userId").value = "";
      document.getElementById("email").value = "";
      document.getElementById("membershipType").value = "";
      document.getElementById("model").value = "";
      document.getElementById("includeModels").value = "";
      document.getElementById("excludeModels").value = "";
      document.getElementById("minTotalTime").value = "";
      document.getElementById("maxTotalTime").value = "";
      document.getElementById("minTokens").value = "";
      document.getElementById("maxTokens").value = "";
      document.getElementById("status").value = "";
      document.getElementById("stream").value = "";
      document.getElementById("hasError").value = "";
      document.getElementById("hasChain").value = "";
      document.getElementById("hasUsage").value = "";
      document.getElementById("reverse").value = "false";
      document.getElementById("pageSize").value = "20";
      document.getElementById("errorText").value = "";

      // é‡ç½®é¡µç 
      currentPageIndex = 0;
      pageSize = 20;

      // åˆ·æ–°æ•°æ®
      fetchLogs();
    }

    async function fetchLogs() {
      // æ„å»ºæŸ¥è¯¢å‚æ•°
      const query = {
        // åˆ†é¡µå‚æ•°
        limit: pageSize,
        offset: currentPageIndex * pageSize,
        reverse: document.getElementById("reverse").value === "true",

        // æ—¶é—´èŒƒå›´
        ...getTimeRangeFilter(),

        // ç”¨æˆ·ç­›é€‰
        ...getUserFilter(),

        // æ¨¡å‹ç­›é€‰
        ...getModelFilter(),

        // æ€§èƒ½ç­›é€‰
        ...getPerformanceFilter(),

        // å…¶ä»–ç­›é€‰
        ...getOtherFilters(),
      };

      // å‘é€è¯·æ±‚åˆ°æ–°çš„APIç«¯ç‚¹
      const data = await makeAuthenticatedRequest("/logs/get", {
        body: JSON.stringify({ query }),
      });

      if (data) {
        updateTable(data);
        showGlobalMessage("æ—¥å¿—è·å–æˆåŠŸ");
      }
    }

    // è·å–Tokenè¯¦ç»†ä¿¡æ¯
    async function fetchTokenDetails(tokens) {
      const data = await makeAuthenticatedRequest("/logs/tokens/get", {
        body: JSON.stringify(tokens),
      });

      if (data) {
        return data.tokens;
      }

      return null;
    }

    // æ‰¹é‡åŠ è½½æ‰€æœ‰Tokenä¿¡æ¯åˆ°ç¼“å­˜
    async function loadAllTokenInfo(tokenKeys) {
      if (tokenKeys.length === 0) return;

      console.log(`æ­£åœ¨åŠ è½½ ${tokenKeys.length} ä¸ªtokençš„è¯¦ç»†ä¿¡æ¯...`);

      try {
        const detailsData = await fetchTokenDetails(tokenKeys);
        if (detailsData) {
          // å°†æ‰€æœ‰tokenä¿¡æ¯å­˜å…¥ç¼“å­˜
          Object.entries(detailsData).forEach(([key, info]) => {
            tokenInfoCache[key] = info;
          });

          allTokensLoaded = true;
          console.log(
            `æˆåŠŸåŠ è½½ ${Object.keys(detailsData).length} ä¸ªtokençš„è¯¦ç»†ä¿¡æ¯`,
          );
          showGlobalMessage(
            `å·²ç¼“å­˜ ${Object.keys(detailsData).length} ä¸ªTokenä¿¡æ¯`,
          );
        }
      } catch (error) {
        console.error("åŠ è½½Tokenä¿¡æ¯å¤±è´¥:", error);
      }
    }

    // å¯¼å‡ºæ—¥å¿—æ•°æ®
    async function exportLogs() {
      // è·å–å½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ‰€æœ‰æ•°æ®
      const query = {
        // ä¸é™åˆ¶æ•°é‡ï¼Œå¯¼å‡ºæ‰€æœ‰æ•°æ®
        limit: 10000,
        offset: 0,
        reverse: document.getElementById("reverse").value === "true",

        // æ—¶é—´èŒƒå›´
        ...getTimeRangeFilter(),

        // ç”¨æˆ·ç­›é€‰
        ...getUserFilter(),

        // æ¨¡å‹ç­›é€‰
        ...getModelFilter(),

        // æ€§èƒ½ç­›é€‰
        ...getPerformanceFilter(),

        // å…¶ä»–ç­›é€‰
        ...getOtherFilters(),
      };

      const data = await makeAuthenticatedRequest("/logs/get", {
        method: "POST",
        body: JSON.stringify({ query }),
      });

      if (data) {
        // åˆ›å»ºCSVæ ¼å¼çš„æ•°æ®
        const csvContent = createCSVFromLogs(data.logs);

        // ä¸‹è½½CSVæ–‡ä»¶
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `logs_${new Date().toISOString()}.csv`);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showGlobalMessage(`æˆåŠŸå¯¼å‡º ${data.logs.length} æ¡æ—¥å¿—è®°å½•`);
      }
    }

    // åˆ›å»ºCSVå†…å®¹
    function createCSVFromLogs(logs) {
      const headers = [
        "ID",
        "æ—¶é—´",
        "æ¨¡å‹",
        "Token Key",
        "ç”¨æˆ·é‚®ç®±",
        "ä¼šå‘˜ç±»å‹",
        "è€—æ—¶(ç§’)",
        "è¾“å…¥Tokens",
        "è¾“å‡ºTokens",
        "æµå¼",
        "çŠ¶æ€",
        "é”™è¯¯ä¿¡æ¯",
      ];

      const rows = logs.map((log) => {
        const tokenInfo = log.token_info || {};
        const stripe = tokenInfo.stripe || {};
        const usage = log.chain?.usage || {};
        const user = tokenInfo.user || {};

        return [
          log.id,
          new Date(log.timestamp).toLocaleString(),
          log.model,
          tokenInfo.key || "-",
          user.email || "-",
          stripe.membership_type || "-",
          log.timing.total.toFixed(2),
          usage.input || 0,
          usage.output || 0,
          log.stream ? "æ˜¯" : "å¦",
          log.status,
          typeof log.error === "string" ? log.error : log.error?.error || "-",
        ];
      });

      // è½¬æ¢ä¸ºCSVæ ¼å¼
      const csvRows = [headers, ...rows].map((row) =>
        row.map((cell) => `"${String(cell).replace(/"/g, '""')}"`).join(","),
      );

      return csvRows.join("\n");
    }

    // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
    document
      .getElementById("autoRefresh")
      .addEventListener("change", function (e) {
        if (e.target.checked) {
          refreshInterval = setInterval(fetchLogs, 60000);
        } else {
          clearInterval(refreshInterval);
        }
      });

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è·å–æ—¥å¿—
    document.addEventListener("DOMContentLoaded", () => {
      const authToken = getAuthToken();
      if (authToken) {
        document.getElementById("authToken").value = authToken;

        // è®¾ç½®é»˜è®¤é¡µå¤§å°
        pageSize = parseInt(
          document.getElementById("pageSize").value || "20",
        );
        document.getElementById("customPageSize").value = pageSize;

        fetchLogs();
      }
      // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
      refreshInterval = setInterval(fetchLogs, 60000);

      // æ·»åŠ é¡µç è¾“å…¥æ¡†å›è½¦é”®æ”¯æŒ
      document
        .getElementById("pageNumberInput")
        .addEventListener("keyup", function (event) {
          if (event.key === "Enter") {
            jumpToPage();
          }
        });

      // æ·»åŠ é¡µé¢å¤§å°è¾“å…¥æ¡†å›è½¦é”®æ”¯æŒ
      document
        .getElementById("customPageSize")
        .addEventListener("keyup", function (event) {
          if (event.key === "Enter") {
            changePageSize();
          }
        });
    });

    // åˆå§‹åŒ– token å¤„ç†
    initializeTokenHandling("authToken");

    // æ·»åŠ æ¸…ç†é€»è¾‘
    window.addEventListener("beforeunload", () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });

    // æ·»åŠ æ¨¡æ€æ¡†å…³é—­é€»è¾‘
    document.querySelectorAll(".modal .close").forEach((closeBtn) => {
      closeBtn.onclick = function () {
        this.closest(".modal").style.display = "none";
      };
    });

    window.onclick = function (event) {
      if (event.target.classList.contains("modal")) {
        event.target.style.display = "none";
      }
    };

    /**
     * è§£æå¯¹è¯å†…å®¹
     * @param {string} promptStr - åŸå§‹promptå­—ç¬¦ä¸²
     * @returns {Array<{role: string, content: string}>} è§£æåçš„å¯¹è¯æ•°ç»„
     */
    function parsePrompt(promptStr) {
      if (!promptStr) return [];

      // å°è¯•è§£æJSONæ ¼å¼çš„prompt
      try {
        const parsed = JSON.parse(promptStr);

        // å¦‚æœæ˜¯å·²è§£æçš„æ ¼å¼
        if (Array.isArray(parsed)) {
          return parsed.map((msg) => ({
            role: msg.role,
            content: msg.content,
          }));
        }
      } catch (e) {
        // å¦‚æœè§£æJSONå¤±è´¥ï¼Œè¯´æ˜æ˜¯åŸå§‹å­—ç¬¦ä¸²æ ¼å¼ï¼Œä½¿ç”¨åŸæ¥çš„è§£æé€»è¾‘
      }

      const messages = [];
      const lines = promptStr.split("\n");
      let currentRole = "";
      let currentContent = "";

      const roleMap = {
        BEGIN_SYSTEM: "system",
        BEGIN_USER: "user",
        BEGIN_ASSISTANT: "assistant",
      };

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // æ£€æŸ¥æ˜¯å¦æ˜¯è§’è‰²æ ‡è®°è¡Œ
        let foundRole = false;
        for (const [marker, role] of Object.entries(roleMap)) {
          if (line.includes(marker)) {
            // ä¿å­˜ä¹‹å‰çš„æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (currentRole && currentContent.trim()) {
              messages.push({
                role: currentRole,
                content: currentContent.trim(),
              });
            }
            // è®¾ç½®æ–°è§’è‰²
            currentRole = role;
            currentContent = "";
            foundRole = true;
            break;
          }
        }

        // å¦‚æœä¸æ˜¯è§’è‰²æ ‡è®°è¡Œä¸”ä¸æ˜¯ENDæ ‡è®°è¡Œï¼Œåˆ™æ·»åŠ åˆ°å½“å‰å†…å®¹
        if (!foundRole && !line.includes("END_")) {
          currentContent += line + "\n";
        }
      }

      // æ·»åŠ æœ€åä¸€æ¡æ¶ˆæ¯
      if (currentRole && currentContent.trim()) {
        messages.push({
          role: currentRole,
          content: currentContent.trim(),
        });
      }

      return messages;
    }

    function escapeHtml(content) {
      // å…ˆè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
      const escaped = content
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
      return escaped;
    }

    function escapeHtmlAndControlChars(content) {
      // å…ˆè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
      let escaped = content
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");

      // ç„¶åè½¬ä¹‰æ§åˆ¶å­—ç¬¦
      escaped = escaped
        .replace(/\\/g, "\\\\")
        .replace(/\n/g, "\\n")
        .replace(/\t/g, "\\t")
        .replace(/\r/g, "\\r");

      return escaped;
    }

    /**
     * æ ¼å¼åŒ–å¯¹è¯å†…å®¹ä¸ºHTMLè¡¨æ ¼
     * @param {Array<{role: string, content: string}>} messages - å¯¹è¯æ¶ˆæ¯æ•°ç»„
     * @returns {string} HTMLè¡¨æ ¼å­—ç¬¦ä¸²
     */
    function formatPromptToTable(messages) {
      if (!messages || messages.length === 0) {
        return "<p>æ— å¯¹è¯å†…å®¹</p>";
      }

      const roleLabels = {
        system: "ç³»ç»Ÿ",
        user: "ç”¨æˆ·",
        assistant: "åŠ©æ‰‹",
      };

      return `<table class="message-table"><thead><tr><th>è§’è‰²</th><th>å†…å®¹</th></tr></thead><tbody>${messages
        .map(
          (msg) =>
            `<tr><td>${roleLabels[msg.role] || msg.role}</td><td>${escapeHtml(
              msg.content,
            ).replace(/\n/g, "<br>")}</td></tr>`,
        )
        .join("")}</tbody></table>`;
    }

    /**
     * æ˜¾ç¤ºå¯¹è¯è¯¦æƒ…å¼¹çª—
     * @param {string} promptStr - å¯¹è¯æç¤ºå­—ç¬¦ä¸²
     * @param {string} thinkStr - æ€è€ƒè¿‡ç¨‹å­—ç¬¦ä¸²
     * @param {Array} delaysTuple - å»¶è¿Ÿæ•°æ®æ•°ç»„
     */
    function showConversationModal(promptStr, thinkStr, delaysTuple) {
      try {
        const modal = document.getElementById("conversationModal");
        const dialogContent = document.getElementById("dialogContent");
        const thinkContent = document.getElementById("thinkContent");
        const delaysContent = document.getElementById("delaysContent");
        const tabPrompt = document.getElementById("tab-prompt");
        const tabThink = document.getElementById("tab-think");
        const tabDelays = document.getElementById("tab-delays");
        const delaysTableBody = document.querySelector("#delaysTable tbody");
        const delayChartContainer = document.querySelector(
          ".delay-chart-container",
        );

        if (
          !modal ||
          !dialogContent ||
          !thinkContent ||
          !delaysContent ||
          !tabPrompt ||
          !tabThink ||
          !tabDelays ||
          !delaysTableBody ||
          !delayChartContainer
        ) {
          console.error("Modal elements not found");
          return;
        }

        // å¤„ç† Prompt
        try {
          const messages = parsePrompt(promptStr);
          dialogContent.innerHTML = formatPromptToTable(messages);
        } catch (e) {
          console.error("è§£æ Prompt æ•°æ®å¤±è´¥:", e);
          dialogContent.innerHTML = "<p>æ— æ³•åŠ è½½å¯¹è¯å†…å®¹ã€‚</p>";
        }

        // å¤„ç†æ€è€ƒè¿‡ç¨‹
        if (thinkStr && typeof thinkStr === "string") {
          document.getElementById("thinkText").textContent = thinkStr;
          tabThink.style.display = "";
        } else {
          document.getElementById("thinkText").textContent = "æ— æ€è€ƒè¿‡ç¨‹";
          tabThink.style.display = "none";
        }

        // å¤„ç† Delays
        delaysTableBody.innerHTML = "";
        delayChartContainer.innerHTML = '<canvas id="delayChart"></canvas>';

        let fullText = "";
        let delayPoints = [];
        let chartDataPoints = [{ time: 0, chars: 0, text: "" }];

        if (delaysTuple) {
          if (
            Array.isArray(delaysTuple) &&
            delaysTuple.length === 2 &&
            typeof delaysTuple[0] === "string" &&
            Array.isArray(delaysTuple[1])
          ) {
            fullText = delaysTuple[0];
            delayPoints = delaysTuple[1];
          } else {
            console.warn("Delays data format is incorrect:", delaysTuple);
          }
        }

        if (delayPoints.length > 0) {
          const textChars = Array.from(fullText);
          let currentIndex = 0;
          let totalChars = 0;
          let totalTime = 0;

          delayPoints.forEach(([length, deltaTime], index) => {
            if (
              typeof length !== "number" ||
              typeof deltaTime !== "number" ||
              length < 0 ||
              deltaTime < 0
            ) {
              console.warn(
                `Skipping invalid delay point at index ${index}:`,
                [length, deltaTime],
              );
              return;
            }

            const chunkChars = textChars.slice(currentIndex, currentIndex + length);
            const chunkText = chunkChars.join('');
            currentIndex += length;
            totalChars += length;
            totalTime += deltaTime;

            const rate = deltaTime > 0 ? length / deltaTime : Infinity;
            const avgRate = totalTime > 0 ? totalChars / totalTime : Infinity;

            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${index + 1}</td>
            <td>${escapeHtmlAndControlChars(chunkText)}</td>
            <td>${deltaTime.toFixed(3)}</td>
            <td>${isFinite(rate) ? rate.toFixed(1) : "N/A"} (å¹³å‡: ${
              isFinite(avgRate) ? avgRate.toFixed(1) : "N/A"
            })</td>
          `;
            delaysTableBody.appendChild(row);

            chartDataPoints.push({
              time: totalTime,
              chars: totalChars,
              text: chunkText,
            });
          });

          initDelayChart(chartDataPoints);
          tabDelays.style.display = "";
        } else {
          delaysTableBody.innerHTML =
            '<tr><td colspan="4">æ— å»¶è¿Ÿæ•°æ®</td></tr>';
          delayChartContainer.innerHTML =
            '<div style="text-align: center; padding: 20px;">æ— å»¶è¿Ÿæ•°æ®å¯ä¾›åˆ†æ</div>';
          tabDelays.style.display = "none";
        }

        // è®¾ç½®æ ‡ç­¾é¡µ
        tabPrompt.onclick = () => setActiveTab("prompt");
        tabThink.onclick = () => setActiveTab("think");
        tabDelays.onclick = () => setActiveTab("delays");

        setActiveTab("prompt");
        modal.style.display = "block";
      } catch (e) {
        console.error("æ˜¾ç¤ºå¯¹è¯è¯¦æƒ…å¤±è´¥:", e);
      }
    }

    /**
     * è®¾ç½®å½“å‰æ´»åŠ¨æ ‡ç­¾é¡µ
     * @param {string} tabName - æ ‡ç­¾é¡µåç§° ('prompt' æˆ– 'delays')
     */
    function setActiveTab(tabName) {
      const dialogContent = document.getElementById("dialogContent");
      const thinkContent = document.getElementById("thinkContent");
      const delaysContent = document.getElementById("delaysContent");
      const tabPrompt = document.getElementById("tab-prompt");
      const tabThink = document.getElementById("tab-think");
      const tabDelays = document.getElementById("tab-delays");

      if (
        !dialogContent ||
        !thinkContent ||
        !delaysContent ||
        !tabPrompt ||
        !tabThink ||
        !tabDelays
      ) {
        console.error("Tab elements not found");
        return;
      }

      if (tabName === "prompt") {
        dialogContent.classList.add("active");
        thinkContent.classList.remove("active");
        delaysContent.classList.remove("active");
        tabPrompt.classList.add("active");
        tabThink.classList.remove("active");
        tabDelays.classList.remove("active");
      } else if (tabName === "think") {
        dialogContent.classList.remove("active");
        thinkContent.classList.add("active");
        delaysContent.classList.remove("active");
        tabPrompt.classList.remove("active");
        tabThink.classList.add("active");
        tabDelays.classList.remove("active");
      } else {
        dialogContent.classList.remove("active");
        thinkContent.classList.remove("active");
        delaysContent.classList.add("active");
        tabPrompt.classList.remove("active");
        tabThink.classList.remove("active");
        tabDelays.classList.add("active");
      }
    }

    /**
     * åˆå§‹åŒ–å»¶è¿Ÿå›¾è¡¨
     * @param {Array<{time: number, chars: number, text: string}>} chartDataPoints - åŒ…å«ç´¯è®¡æ—¶é—´å’Œå­—ç¬¦æ•°ä»¥åŠå—æ–‡æœ¬çš„æ•°æ®ç‚¹æ•°ç»„
     */
    function initDelayChart(chartDataPoints) {
      if (!chartDataPoints || chartDataPoints.length <= 1) {
        const container = document.querySelector(".delay-chart-container");
        if (container) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px;">å»¶è¿Ÿæ•°æ®ä¸è¶³ï¼Œæ— æ³•ç»˜åˆ¶å›¾è¡¨</div>';
        }
        return;
      }

      const ctx = document.getElementById("delayChart");
      if (!ctx) {
        console.error("æ‰¾ä¸åˆ°å›¾è¡¨canvaså…ƒç´ ");
        return;
      }

      const existingChart = Chart.getChart(ctx);
      if (existingChart) {
        existingChart.destroy();
      }

      const maxPoints = 100;
      let sampledPoints = chartDataPoints;

      if (chartDataPoints.length > maxPoints) {
        sampledPoints = [];
        const interval = (chartDataPoints.length - 2) / (maxPoints - 2);

        sampledPoints.push(chartDataPoints[0]);

        for (let i = 1; i < maxPoints - 1; i++) {
          const rawIndex = Math.round(i * interval);
          const actualIndex = Math.min(
            rawIndex + 1,
            chartDataPoints.length - 2,
          );
          sampledPoints.push(chartDataPoints[actualIndex]);
        }

        sampledPoints.push(chartDataPoints[chartDataPoints.length - 1]);
      }

      new Chart(ctx, {
        type: "line",
        data: {
          datasets: [
            {
              label: "ç´¯è®¡è¾“å‡ºå­—ç¬¦æ•°",
              data: sampledPoints.map((point) => ({
                x: point.time,
                y: point.chars,
              })),
              borderColor: "rgb(75,192,192)",
              backgroundColor: "rgba(75,192,192,0.2)",
              tension: 0.1,
              fill: true,
              pointRadius: 3,
              pointHoverRadius: 5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: "å­—ç¬¦è¾“å‡ºè¿›åº¦",
            },
            tooltip: {
              callbacks: {
                title: function (context) {
                  const pointIndex = context[0].dataIndex;
                  if (pointIndex < sampledPoints.length) {
                    return `ç”¨æ—¶: ${sampledPoints[pointIndex].time.toFixed(
                      1,
                    )}ç§’`;
                  }
                  return "";
                },
                label: function (context) {
                  const pointIndex = context.dataIndex;
                  if (pointIndex < sampledPoints.length) {
                    const point = sampledPoints[pointIndex];
                    const prevPoint =
                      pointIndex > 0
                        ? sampledPoints[pointIndex - 1]
                        : { time: 0, chars: 0, text: "" };

                    const deltaTime = point.time - prevPoint.time;
                    const deltaChars = point.chars - prevPoint.chars;
                    const currentRate =
                      deltaTime > 0
                        ? (deltaChars / deltaTime).toFixed(1)
                        : "N/A";
                    const avgRate =
                      point.time > 0
                        ? (point.chars / point.time).toFixed(1)
                        : "N/A";

                    const chunkText = point.text || "";

                    return [
                      `ç´¯è®¡å­—ç¬¦: ${point.chars}`,
                      `å¹³å‡é€Ÿç‡: ${avgRate} å­—ç¬¦/ç§’`,
                      `å½“å‰å—é€Ÿç‡: ${currentRate} å­—ç¬¦/ç§’`,
                      `å½“å‰å—æ–‡æœ¬: ${escapeHtmlAndControlChars(
                        chunkText.length > 50
                          ? chunkText.substring(0, 50) + "..."
                          : chunkText,
                      )}`,
                    ];
                  }
                  return "";
                },
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "ç´¯è®¡å­—ç¬¦æ•°",
              },
            },
            x: {
              type: "linear",
              beginAtZero: true,
              title: {
                display: true,
                text: "ç´¯è®¡ç”¨æ—¶ï¼ˆç§’ï¼‰",
              },
              ticks: {
                callback: function (value) {
                  return value.toFixed(1) + "s";
                },
              },
            },
          },
        },
      });
    }

    /**
     * æ ¼å¼åŒ–ä½¿ç”¨é‡ä¿¡æ¯
     * @param {Object} usage - ä½¿ç”¨é‡å¯¹è±¡ { input: number, output: number }
     * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
     */
    function formatUsage(usage) {
      if (!usage) return "-";
      return `${usage.input} / ${usage.output}`;
    }
  </script>
</body>
</html>