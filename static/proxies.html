<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;,">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»£ç†ä¿¡æ¯ç®¡ç†</title>
  <!-- å¼•å…¥å…±äº«æ ·å¼ -->
  <link rel="stylesheet" href="/static/shared-styles.css">
  <script src="/static/shared.js"></script>
  <style>
    /* ä»£ç†åˆ—è¡¨å¸ƒå±€æ ·å¼ */
    .proxy-system {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
      overflow: hidden;
      height: calc(100vh - 250px);
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
      background: var(--card-background);
    }

    .toolbar .search-box {
      flex: 1;
      margin-right: 8px;
      position: relative;
    }

    .toolbar .search-box input {
      width: 100%;
      padding-left: 32px;
    }

    .toolbar .search-box::before {
      content: "ğŸ”";
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .proxy-list {
      flex: 1;
      overflow: auto;
      position: relative;
      user-select: none;
      padding: 0 12px 12px 12px;
    }

    .proxy-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
    }

    .proxy-table th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--card-background);
      padding: 10px;
      text-align: left;
      font-weight: 500;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .proxy-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .proxy-table tr {
      cursor: pointer;
    }

    .proxy-table tr:hover {
      background: var(--primary-color-alpha);
    }

    .proxy-table tr.selected {
      background: var(--primary-color-alpha);
    }

    .proxy-table tr.general {
      font-weight: bold;
    }

    .status-bar {
      padding: 8px;
      background: var(--card-background);
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }

    /* å³é”®èœå• */
    .context-menu {
      position: absolute;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 4px 0;
      z-index: 1000;
      min-width: 180px;
      display: none;
    }

    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
    }

    .context-menu-item:hover {
      background: var(--primary-color-alpha);
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }

    .context-menu-shortcut {
      margin-left: auto;
      color: var(--text-secondary);
      font-size: 12px;
    }

    /* ç­›é€‰é¢æ¿ */
    .filter-panel {
      padding: 16px;
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
    }

    .filter-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
    .multiselect {
      position: relative;
      width: 100%;
    }

    .multiselect-dropdown {
      width: 100%;
      padding: 8px 12px;
      background: var(--input-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 44px;
    }

    .multiselect-dropdown:after {
      content: "â–¼";
      font-size: 12px;
    }

    .multiselect-dropdown.active:after {
      content: "â–²";
    }

    .multiselect-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }

    .multiselect-options.show {
      display: block;
    }

    .multiselect-option {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: baseline;
    }

    .multiselect-option:hover {
      background: var(--primary-color-alpha);
    }

    .multiselect-option input {
      margin-right: 8px;
    }

    .multiselect-option label {
      margin: 0;
    }

    .selected-options {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      min-height: 20px;
    }

    .selected-option {
      background: var(--primary-color-alpha);
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      font-size: 12px;
    }

    .selected-option button {
      background: none;
      border: none;
      font-size: 14px;
      margin-left: 4px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    /* å¯¹è¯æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-background);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 90%;
      max-width: 500px;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .modal-header {
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }

    .modal-body {
      margin-bottom: 15px;
    }

    .modal-footer {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
      text-align: right;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* å‘ä¸Šå±•å¼€çš„å­èœå•æ ·å¼ */
    .proxy-menu.open-upward .proxy-submenu {
      top: auto;
      bottom: 0;
    }

    /* å‘å·¦å±•å¼€çš„å­èœå•æ ·å¼ */
    .proxy-menu.open-leftward .proxy-submenu {
      right: 100%;
      left: auto;
    }

    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <h1>ä»£ç†ä¿¡æ¯ç®¡ç†</h1>

  <div class="container">
    <div class="form-group">
      <label>è®¤è¯ä»¤ç‰Œ:</label>
      <input type="password" id="authToken" placeholder="è¾“å…¥ AUTH_TOKEN">
    </div>
  </div>

  <!-- ç­›é€‰é¢æ¿ -->
  <div class="filter-panel">
    <div class="filter-row">
      <div class="filter-group">
        <label>ä»£ç†ç±»å‹:</label>
        <div class="multiselect">
          <div class="multiselect-dropdown">
            <div class="selected-options" id="selectedProxyTypes"></div>
          </div>
          <div class="multiselect-options">
            <div class="multiselect-option">
              <input type="checkbox" id="type-non" value="non" checked> <label for="type-non">ä¸ä½¿ç”¨ä»£ç†</label>
            </div>
            <div class="multiselect-option">
              <input type="checkbox" id="type-sys" value="sys" checked> <label for="type-sys">ç³»ç»Ÿä»£ç†</label>
            </div>
            <div class="multiselect-option">
              <input type="checkbox" id="type-http" value="http" checked> <label for="type-http">HTTP</label>
            </div>
            <div class="multiselect-option">
              <input type="checkbox" id="type-https" value="https" checked> <label for="type-https">HTTPS</label>
            </div>
            <div class="multiselect-option">
              <input type="checkbox" id="type-socks4" value="socks4" checked> <label for="type-socks4">SOCKS4</label>
            </div>
            <div class="multiselect-option">
              <input type="checkbox" id="type-socks5" value="socks5" checked> <label for="type-socks5">SOCKS5</label>
            </div>
            <div class="multiselect-option">
              <input type="checkbox" id="type-socks5h" value="socks5h" checked> <label
                for="type-socks5h">SOCKS5H</label>
            </div>
          </div>
        </div>
      </div>
      <div class="button-group" style="flex: 1;">
        <button id="refreshBtn" onclick="getProxyInfo()" class="primary">
          <span>åˆ·æ–°åˆ—è¡¨</span>
          <span class="context-menu-shortcut">F5</span>
        </button>
        <button id="addProxyBtn" onclick="addProxy()" class="secondary">æ·»åŠ ä»£ç†</button>
        <button id="exportBtn" onclick="exportProxies()" class="secondary">å¯¼å‡ºé…ç½®</button>
        <button id="importBtn" onclick="importProxies()" class="secondary">å¯¼å…¥é…ç½®</button>
      </div>
    </div>
  </div>

  <!-- ä»£ç†åˆ—è¡¨åŒºåŸŸ -->
  <div class="proxy-system">
    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœç´¢ä»£ç†åç§°...">
      </div>
    </div>

    <div class="proxy-list">
      <table class="proxy-table">
        <thead>
          <tr>
            <th style="width: 20%;">ä»£ç†åç§°</th>
            <th style="width: 20%;">ä»£ç†ç±»å‹</th>
            <th style="width: 50%;">ä»£ç†åœ°å€</th>
          </tr>
        </thead>
        <tbody id="proxyListBody">
          <!-- åŠ¨æ€ç”Ÿæˆçš„ä»£ç†åˆ—è¡¨ -->
        </tbody>
      </table>
      <div id="emptyState" style="display: none; padding: 40px; text-align: center; color: var(--text-secondary);">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸŒ</div>
        <h3>æ²¡æœ‰æ‰¾åˆ°ä»£ç†</h3>
        <p>è¯·æ·»åŠ ä»£ç†æˆ–æ›´æ”¹ç­›é€‰æ¡ä»¶</p>
        <button onclick="addProxy()" class="primary">æ·»åŠ ä»£ç†</button>
      </div>
    </div>

    <div class="status-bar">
      <div id="selectionStatus">å·²é€‰æ‹©: 0 ä¸ªé¡¹ç›®</div>
      <div id="totalCount">å…± 0 ä¸ªä»£ç†</div>
    </div>
  </div>

  <!-- å³é”®èœå• -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item" onclick="setAsGeneral()">
      <span>è®¾ä¸ºé€šç”¨ä»£ç†</span>
      <span class="context-menu-shortcut">Ctrl+G</span>
    </div>
    <div class="context-menu-item" onclick="copyProxyUrl()">
      <span>å¤åˆ¶ä»£ç†åœ°å€</span>
      <span class="context-menu-shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="deleteSelectedProxies()">
      <span>åˆ é™¤</span>
      <span class="context-menu-shortcut">Delete</span>
    </div>
  </div>

  <!-- æ·»åŠ ä»£ç†å¯¹è¯æ¡† -->
  <div class="modal-backdrop" id="addProxyModal-backdrop"></div>
  <div class="modal" id="addProxyModal">
    <div class="modal-header">
      <h3>æ·»åŠ ä»£ç†</h3>
      <button class="modal-close" onclick="closeModal('addProxyModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>ä»£ç†åç§°:</label>
        <input type="text" id="proxyName" placeholder="è¾“å…¥ä»£ç†åç§°">
      </div>
      <div class="form-group">
        <label>ä»£ç†ç±»å‹:</label>
        <select id="proxyType" onchange="toggleProxyUrl()">
          <option value="non">ä¸ä½¿ç”¨ä»£ç†</option>
          <option value="sys">ç³»ç»Ÿä»£ç†</option>
          <option value="custom" selected>è‡ªå®šä¹‰ä»£ç†</option>
        </select>
      </div>
      <div class="form-group" id="proxyUrlGroup">
        <label>ä»£ç†åœ°å€:</label>
        <input type="text" id="proxyUrl" placeholder="ä¾‹å¦‚: http://localhost:7890">
        <div class="help-text">æ”¯æŒçš„æ ¼å¼: http://localhost:7890, socks5://username:password@localhost:1080</div>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('addProxyModal')" class="secondary">å–æ¶ˆ</button>
      <button onclick="confirmAddProxy()" class="primary">æ·»åŠ </button>
    </div>
  </div>

  <!-- ç¡®è®¤åˆ é™¤å¯¹è¯æ¡† -->
  <div class="modal-backdrop" id="confirmModal-backdrop"></div>
  <div class="modal" id="confirmModal">
    <div class="modal-header">
      <h3>ç¡®è®¤åˆ é™¤</h3>
      <button class="modal-close" onclick="closeModal('confirmModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <p id="confirmMessage">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ä»£ç†å—ï¼Ÿ</p>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('confirmModal')" class="secondary">å–æ¶ˆ</button>
      <button onclick="confirmDeleteProxies()" class="danger">åˆ é™¤</button>
    </div>
  </div>

  <!-- å¯¼å…¥å¯¼å‡ºå¯¹è¯æ¡† -->
  <div class="modal-backdrop" id="importModal-backdrop"></div>
  <div class="modal" id="importModal">
    <div class="modal-header">
      <h3>å¯¼å…¥ä»£ç†é…ç½®</h3>
      <button class="modal-close" onclick="closeModal('importModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>é€‰æ‹©JSONæ–‡ä»¶:</label>
        <input type="file" id="importFile" accept=".json">
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('importModal')" class="secondary">å–æ¶ˆ</button>
      <button onclick="confirmImport()" class="primary">å¯¼å…¥</button>
    </div>
  </div>

  <!-- å…¨å±€é€šçŸ¥åŒºåŸŸ -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // å…¨å±€å˜é‡
    let allProxies = {};
    let generalProxy = '';
    let selectedProxies = new Set();
    let proxiesToDelete = [];

    // åˆå§‹åŒ–TokenHandling
    initializeTokenHandling('authToken');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // è·å–ä»£ç†ä¿¡æ¯
      getProxyInfo();

      // ç›‘å¬æœç´¢è¾“å…¥
      document.getElementById('searchInput').addEventListener('input', filterProxies);

      // åˆå§‹åŒ–å¤šé€‰ä¸‹æ‹‰æ¡†
      initMultiSelect();

      // è®¾ç½®é”®ç›˜å¿«æ·é”®
      setupKeyboardShortcuts();

      // è®¾ç½®ä¸Šä¸‹æ–‡èœå•
      setupContextMenu();

      updateStatusBar();
    });

    // åˆå§‹åŒ–å¤šé€‰ä¸‹æ‹‰æ¡†
    // åˆå§‹åŒ–å¤šé€‰ä¸‹æ‹‰æ¡†
    function initMultiSelect() {
      // ç‚¹å‡»ä¸‹æ‹‰æ¡†æ˜¾ç¤º/éšè—é€‰é¡¹
      const dropdown = document.querySelector('.multiselect-dropdown');
      const options = document.querySelector('.multiselect-options');

      dropdown.addEventListener('click', function () {
        dropdown.classList.toggle('active');
        options.classList.toggle('show');
      });

      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
      document.addEventListener('click', function (e) {
        if (!e.target.closest('.multiselect')) {
          dropdown.classList.remove('active');
          options.classList.remove('show');
        }
      });

      // ç›‘å¬å¤é€‰æ¡†å˜åŒ–
      const checkboxes = document.querySelectorAll('.multiselect-option input');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
          updateSelectedOptions();
          filterProxies();
        });
      });

      // æ·»åŠ å¯¹æ•´ä¸ªé€‰é¡¹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å¤„ç†
      const optionDivs = document.querySelectorAll('.multiselect-option');
      optionDivs.forEach(div => {
        div.addEventListener('click', function (e) {

          // è·å–è¯¥é€‰é¡¹å†…çš„å¤é€‰æ¡†å¹¶åˆ‡æ¢å…¶çŠ¶æ€
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;

          // æ‰‹åŠ¨è§¦å‘ change äº‹ä»¶
          const event = new Event('change');
          checkbox.dispatchEvent(event);
        });
      });

      // åˆå§‹åŒ–å·²é€‰é¡¹
      updateSelectedOptions();
    }
    // æ›´æ–°å·²é€‰é€‰é¡¹æ˜¾ç¤º
    function updateSelectedOptions() {
      const selectedContainer = document.getElementById('selectedProxyTypes');
      const checkboxes = document.querySelectorAll('.multiselect-option input:checked');

      let html = '';
      checkboxes.forEach(checkbox => {
        const label = checkbox.nextElementSibling.textContent;
        html += `
          <span class="selected-option">
            ${label}
          </span>
        `;
      });

      selectedContainer.innerHTML = html || '<span style="color: var(--text-secondary);">è¯·é€‰æ‹©ä»£ç†ç±»å‹...</span>';
    }

    // æ£€æµ‹æ˜¯Macè¿˜æ˜¯å…¶ä»–ç³»ç»Ÿï¼ŒMacä½¿ç”¨metaKey(Commandé”®)ï¼Œå…¶ä»–ç³»ç»Ÿä½¿ç”¨ctrlKey
    function isModifierKey(e) {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      return isMac ? e.metaKey : e.ctrlKey;
    }

    // è®¾ç½®é”®ç›˜å¿«æ·é”®
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function (e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          return;
        }

        switch (e.key) {
          case 'Delete':
            e.preventDefault();
            deleteSelectedProxies();
            break;
          case 'F5':
            e.preventDefault();
            getProxyInfo();
            break;
          case 'g':
            if (isModifierKey(e)) {
              e.preventDefault();
              setAsGeneral();
            }
            break;
          case 'c':
            if (isModifierKey(e)) {
              e.preventDefault();
              copyProxyUrl();
            }
            break;
          case 'Escape':
            closeAllModals();
            break;
        }
      });
    }

    // è®¾ç½®ä¸Šä¸‹æ–‡èœå•
    function setupContextMenu() {
      const proxyList = document.querySelector('.proxy-list');
      const contextMenu = document.getElementById('contextMenu');

      proxyList.addEventListener('contextmenu', function (e) {
        // è·å–ç‚¹å‡»çš„è¡Œ
        const row = e.target.closest('tr');

        // å¦‚æœæ²¡æœ‰è¡Œæˆ–è€…æ˜¯è¡¨å¤´è¡Œ(theadä¸­çš„tr)åˆ™ä¸æ˜¾ç¤ºèœå•
        if (!row || row.closest('thead')) return;

        // ç¡®ä¿è¡Œæœ‰æ•°æ®å±æ€§ï¼Œè¿™æ˜¯æ•°æ®è¡Œçš„æ ‡è¯†
        if (!row.dataset.name) return;

        e.preventDefault();

        const proxyName = row.dataset.name;

        if (!selectedProxies.has(proxyName)) {
          clearSelection();
          selectProxy(proxyName);
        }

        // æ˜¾ç¤ºèœå•å¹¶æ™ºèƒ½å®šä½
        contextMenu.style.display = 'block';
        positionContextMenu(contextMenu, e.pageX, e.pageY);
      });

      document.addEventListener('click', function () {
        contextMenu.style.display = 'none';
      });

      // é˜»æ­¢å³é”®èœå•å†…éƒ¨ç‚¹å‡»å¯¼è‡´èœå•å…³é—­
      contextMenu.addEventListener('click', function (e) {
        e.stopPropagation();
      });
    }

    // æ”¹è¿›èœå•ä½ç½®è®¡ç®—ï¼Œç¡®ä¿è€ƒè™‘æ»šåŠ¨ä½ç½®
    function positionContextMenu(menu, x, y) {
      // ç¡®ä¿èœå•å¯è§ä»¥è·å–æ­£ç¡®çš„å°ºå¯¸
      menu.style.display = 'block';
      menu.style.visibility = 'hidden';

      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      const scrollY = window.scrollY || document.documentElement.scrollTop;
      const scrollX = window.scrollX || document.documentElement.scrollLeft;

      const menuWidth = menu.offsetWidth;
      const menuHeight = menu.offsetHeight;

      // è®¡ç®—åæ ‡ï¼Œè€ƒè™‘çª—å£è¾¹ç•Œå’Œæ»šåŠ¨ä½ç½®
      let adjustedX = x;
      if (x + menuWidth > windowWidth + scrollX - 10) {
        adjustedX = windowWidth + scrollX - menuWidth - 10;
      }

      let adjustedY = y;
      if (y + menuHeight > windowHeight + scrollY - 10) {
        adjustedY = windowHeight + scrollY - menuHeight - 10;
      }

      // åº”ç”¨è®¡ç®—åçš„ä½ç½®
      menu.style.left = Math.max(scrollX + 10, adjustedX) + 'px';
      menu.style.top = Math.max(scrollY + 10, adjustedY) + 'px';
      menu.style.visibility = 'visible';
    }

    // è·å–ä»£ç†ä¿¡æ¯
    async function getProxyInfo() {
      showToast('æ­£åœ¨åŠ è½½ä»£ç†åˆ—è¡¨...', 'info');

      const data = await makeAuthenticatedRequest('/proxies/get');

      if (data && data.proxies) {
        allProxies = data.proxies.proxies || {};
        generalProxy = data.proxies.general || '';
        renderProxies();
        updateStatusBar();
        showToast('ä»£ç†åˆ—è¡¨å·²æ›´æ–°', 'success');
      } else {
        showToast('è·å–ä»£ç†åˆ—è¡¨å¤±è´¥', 'error');
      }
    }

    // æ¸²æŸ“ä»£ç†åˆ—è¡¨
    function renderProxies() {
      const proxyListBody = document.getElementById('proxyListBody');
      const emptyState = document.getElementById('emptyState');

      const proxyEntries = Object.entries(allProxies);

      if (proxyEntries.length === 0) {
        proxyListBody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      proxyListBody.innerHTML = proxyEntries.map(([name, value]) => {
        const isGeneral = name === generalProxy;
        const type = getProxyType(value);
        const url = (type === 'non' || type === 'sys') ? '-' : value;

        return `
          <tr data-name="${name}" class="${selectedProxies.has(name) ? 'selected' : ''} ${isGeneral ? 'general' : ''}">
            <td>
              <span class="file-icon">ğŸŒ</span>
              ${name}${isGeneral ? ' (é€šç”¨)' : ''}
            </td>
            <td>${formatProxyType(type)}</td>
            <td>${url}</td>
          </tr>
        `;
      }).join('');

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
      const rows = document.querySelectorAll('#proxyListBody tr');
      rows.forEach(row => {
        row.addEventListener('click', function (e) {
          const name = this.dataset.name;

          if (isModifierKey(e)) {
            if (selectedProxies.has(name)) {
              deselectProxy(name);
            } else {
              selectProxy(name, true);
            }
          } else {
            clearSelection();
            selectProxy(name);
          }

          updateSelectionStatus();
        });
      });
    }

    // è·å–ä»£ç†ç±»å‹
    function getProxyType(value) {
      if (value === 'non') return 'non';
      if (value === 'sys') return 'sys';
      try {
        const proxyUrl = new URL(value);
        const protocol = proxyUrl.protocol.replace(':', '');
        return protocol;
      } catch (e) {
        return 'unknown';
      }
    }

    // æ ¼å¼åŒ–ä»£ç†ç±»å‹
    function formatProxyType(type) {
      const types = {
        'non': 'ä¸ä½¿ç”¨ä»£ç†',
        'sys': 'ç³»ç»Ÿä»£ç†',
        'http': 'HTTP',
        'https': 'HTTPS',
        'socks4': 'SOCKS4',
        'socks5': 'SOCKS5',
        'socks5h': 'SOCKS5H',
        'unknown': 'æœªçŸ¥'
      };
      return types[type] || type;
    }

    // éªŒè¯ä»£ç†åœ°å€æ ¼å¼
    function validateProxyUrl(url, type) {
      if (type === 'non' || type === 'sys') return true;

      try {
        const proxyUrl = new URL(url);
        const protocol = proxyUrl.protocol.replace(':', '');

        // æ£€æŸ¥åè®®æ˜¯å¦åˆæ³•
        const validProtocols = ['http', 'https', 'socks4', 'socks5', 'socks5h'];
        if (!validProtocols.includes(protocol)) {
          showToast(`ä¸æ”¯æŒçš„ä»£ç†åè®®: ${protocol}`, 'warning');
          return false;
        }

        // æ£€æŸ¥ä¸»æœºå’Œç«¯å£
        if (!proxyUrl.hostname || !proxyUrl.port) {
          showToast('ä»£ç†åœ°å€å¿…é¡»åŒ…å«ä¸»æœºåå’Œç«¯å£å·', 'warning');
          return false;
        }

        return true;
      } catch (e) {
        showToast('ä»£ç†åœ°å€æ ¼å¼æ— æ•ˆ', 'warning');
        return false;
      }
    }

    // ç­›é€‰ä»£ç†
    function filterProxies() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const selectedTypes = Array.from(document.querySelectorAll('.multiselect-option input:checked')).map(cb => cb.value);

      const filteredProxies = Object.entries(allProxies).filter(([name, value]) => {
        const type = getProxyType(value);
        const nameMatch = name.toLowerCase().includes(searchTerm);
        const typeMatch = selectedTypes.includes(type);

        return nameMatch && typeMatch;
      });

      const filteredObj = Object.fromEntries(filteredProxies);
      renderFilteredProxies(filteredObj);
      updateStatusBar(filteredProxies.length);
    }

    // æ¸²æŸ“ç­›é€‰åçš„ä»£ç†
    function renderFilteredProxies(proxies) {
      const temp = allProxies;
      allProxies = proxies;
      renderProxies();
      allProxies = temp;
    }

    // æ›´æ–°çŠ¶æ€æ 
    function updateStatusBar(filteredCount) {
      const total = Object.keys(allProxies).length;
      const selected = selectedProxies.size;
      const selectionStatus = document.getElementById('selectionStatus');
      const totalCount = document.getElementById('totalCount');

      if (selectionStatus) selectionStatus.textContent = `å·²é€‰æ‹©: ${selected} ä¸ªé¡¹ç›®`;
      if (totalCount) totalCount.textContent = `å…± ${filteredCount || total} ä¸ªä»£ç†`;
    }

    // é€‰æ‹©ä»£ç†
    function selectProxy(name, append = false) {
      if (!name) return;

      if (!append) {
        clearSelection();
      }

      selectedProxies.add(name);
      const row = document.querySelector(`tr[data-name="${name}"]`);
      if (row) {
        row.classList.add('selected');
      }

      updateSelectionStatus();
    }

    // å–æ¶ˆé€‰æ‹©ä»£ç†
    function deselectProxy(name) {
      if (!name) return;

      selectedProxies.delete(name);
      const row = document.querySelector(`tr[data-name="${name}"]`);
      if (row) {
        row.classList.remove('selected');
      }

      updateSelectionStatus();
    }

    // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
    function clearSelection() {
      selectedProxies.clear();
      const rows = document.querySelectorAll('#proxyListBody tr.selected');
      rows.forEach(row => {
        row.classList.remove('selected');
      });

      updateSelectionStatus();
    }

    // æ›´æ–°é€‰æ‹©çŠ¶æ€
    function updateSelectionStatus() {
      updateStatusBar();
    }

    // æ·»åŠ ä»£ç†
    function addProxy() {
      document.getElementById('proxyName').value = '';
      document.getElementById('proxyType').value = 'custom';
      document.getElementById('proxyUrl').value = '';
      toggleProxyUrl();
      showModal('addProxyModal');
    }

    // åˆ‡æ¢ä»£ç†åœ°å€è¾“å…¥æ¡†æ˜¾ç¤º
    function toggleProxyUrl() {
      const type = document.getElementById('proxyType').value;
      const urlGroup = document.getElementById('proxyUrlGroup');
      urlGroup.style.display = type === 'custom' ? 'block' : 'none';
    }

    // ç¡®è®¤æ·»åŠ ä»£ç†
    async function confirmAddProxy() {
      const name = document.getElementById('proxyName').value.trim();
      const type = document.getElementById('proxyType').value;
      const url = document.getElementById('proxyUrl').value.trim();

      if (!name) {
        showToast('è¯·è¾“å…¥ä»£ç†åç§°', 'warning');
        return;
      }

      if (name === 'no' || name === 'system' || name === 'default') {
        showToast('ä¸èƒ½ä½¿ç”¨é¢„ç•™çš„ä»£ç†åç§°', 'warning');
        return;
      }

      if (type === 'custom') {
        if (!url) {
          showToast('è¯·è¾“å…¥ä»£ç†åœ°å€', 'warning');
          return;
        }

        if (!validateProxyUrl(url, type)) {
          return;
        }
      }

      closeModal('addProxyModal');
      showToast('æ­£åœ¨æ·»åŠ ä»£ç†...', 'info');

      const proxy = {
        [name]: type === 'non' || type === 'sys' ? type : url
      };

      const data = await makeAuthenticatedRequest('/proxies/add', {
        body: JSON.stringify({
          proxies: proxy
        })
      });

      if (data) {
        showToast(data.message, 'success');
        getProxyInfo();
      } else {
        showToast('æ·»åŠ ä»£ç†å¤±è´¥', 'error');
      }
    }

    // åˆ é™¤é€‰ä¸­çš„ä»£ç†
    function deleteSelectedProxies() {
      if (selectedProxies.size === 0) {
        showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä»£ç†', 'info');
        return;
      }

      proxiesToDelete = [...selectedProxies];
      document.getElementById('confirmMessage').textContent =
        proxiesToDelete.length > 1 ? `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${proxiesToDelete.length} ä¸ªä»£ç†å—ï¼Ÿ` : 'ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ä»£ç†å—ï¼Ÿ';

      closeContextMenu();
      showModal('confirmModal');

    }

    // ç¡®è®¤åˆ é™¤ä»£ç†
    async function confirmDeleteProxies() {
      if (proxiesToDelete.length === 0) return;

      closeModal('confirmModal');
      showToast('æ­£åœ¨åˆ é™¤ä»£ç†...', 'info');

      const data = await makeAuthenticatedRequest('/proxies/del', {
        body: JSON.stringify({
          names: proxiesToDelete,
          expectation: 'detailed'
        })
      });

      if (data) {
        const failedCount = data.failed_names?.length || 0;
        const successCount = proxiesToDelete.length - failedCount;
        const message = `åˆ é™¤æˆåŠŸ: ${successCount} ä¸ªä»£ç†${failedCount ? `ï¼Œå¤±è´¥: ${failedCount} ä¸ª` : ''}`;

        showToast(message, 'success');
        clearSelection();
        getProxyInfo();
      } else {
        showToast('åˆ é™¤ä»£ç†å¤±è´¥', 'error');
      }

      proxiesToDelete = [];
    }

    // è®¾ç½®ä¸ºé€šç”¨ä»£ç†
    async function setAsGeneral() {
      if (selectedProxies.size !== 1) {
        showToast('è¯·é€‰æ‹©ä¸€ä¸ªä»£ç†è®¾ä¸ºé€šç”¨ä»£ç†', 'info');
        return;
      }

      closeContextMenu();

      const name = [...selectedProxies][0];
      showToast('æ­£åœ¨è®¾ç½®é€šç”¨ä»£ç†...', 'info');

      const data = await makeAuthenticatedRequest('/proxies/set-general', {
        body: JSON.stringify({
          name: name
        })
      });

      if (data) {
        showToast('é€šç”¨ä»£ç†è®¾ç½®æˆåŠŸ', 'success');
        getProxyInfo();
      } else {
        showToast('è®¾ç½®é€šç”¨ä»£ç†å¤±è´¥', 'error');
      }
    }

    // å…³é—­å³é”®èœå•
    function closeContextMenu() {
      const contextMenu = document.getElementById('contextMenu');
      contextMenu.style.display = 'none';
    }

    // å¤åˆ¶ä»£ç†åœ°å€
    function copyProxyUrl() {
      if (selectedProxies.size === 0) {
        showToast('è¯·å…ˆé€‰æ‹©ä»£ç†', 'info');
        return;
      }

      const name = [...selectedProxies][0];
      const value = allProxies[name];

      closeContextMenu();

      if (typeof value === 'string' && value !== 'non' && value !== 'sys') {
        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          navigator.clipboard.writeText(value)
            .then(() => {
              showToast('ä»£ç†åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            })
            .catch(err => {
              // å¦‚æœå‰ªè´´æ¿APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
              fallbackCopy(value);
            });
        } else {
          fallbackCopy(value);
        }
      } else {
        showToast('æ²¡æœ‰å¯å¤åˆ¶çš„ä»£ç†åœ°å€', 'warning');
      }
    }

    // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
    function fallbackCopy(text) {
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
      const textArea = document.createElement('textarea');
      textArea.value = text;

      // è®¾ç½®æ–‡æœ¬åŒºåŸŸçš„æ ·å¼ï¼Œä½¿å…¶ä¸å¯è§
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);

      // é€‰æ‹©æ–‡æœ¬å¹¶å¤åˆ¶
      textArea.focus();
      textArea.select();

      let success = false;
      try {
        // æ‰§è¡Œå¤åˆ¶å‘½ä»¤
        success = document.execCommand('copy');
      } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
      }

      // ç§»é™¤ä¸´æ—¶å…ƒç´ 
      document.body.removeChild(textArea);

      // æ˜¾ç¤ºå¤åˆ¶ç»“æœ
      if (success) {
        showToast('ä»£ç†åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      } else {
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
      }
    }

    // å¯¼å‡ºä»£ç†é…ç½®
    function exportProxies() {
      const config = {
        proxies: allProxies,
        general: generalProxy
      };

      const jsonData = JSON.stringify(config, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'proxies_export.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('ä»£ç†é…ç½®å·²å¯¼å‡º', 'success');
    }

    // å¯¼å…¥ä»£ç†é…ç½®
    function importProxies() {
      showModal('importModal');
    }

    // ç¡®è®¤å¯¼å…¥
    async function confirmImport() {
      const fileInput = document.getElementById('importFile');

      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶', 'warning');
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function (e) {
        try {
          const config = JSON.parse(e.target.result);

          closeModal('importModal');
          showToast('æ­£åœ¨å¯¼å…¥ä»£ç†é…ç½®...', 'info');

          const data = await makeAuthenticatedRequest('/proxies/set', {
            body: JSON.stringify({
              proxies: config
            })
          });

          if (data) {
            showToast('ä»£ç†é…ç½®å¯¼å…¥æˆåŠŸ', 'success');
            fileInput.value = '';
            getProxyInfo();
          }
        } catch (error) {
          showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
        }
      };

      reader.readAsText(file);
    }

    // æ˜¾ç¤ºå¯¹è¯æ¡†
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = 'block';
        backdrop.style.display = 'block';
      }
    }

    // å…³é—­å¯¹è¯æ¡†
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = 'none';
        backdrop.style.display = 'none';
      }
    }

    // å…³é—­æ‰€æœ‰å¯¹è¯æ¡†
    function closeAllModals() {
      const modals = document.querySelectorAll('.modal');
      const backdrops = document.querySelectorAll('.modal-backdrop');

      modals.forEach(modal => {
        modal.style.display = 'none';
      });

      backdrops.forEach(backdrop => {
        backdrop.style.display = 'none';
      });
    }

    // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
    function showToast(message, type = 'info', duration = 3000) {
      // è·å–æˆ–åˆ›å»ºé€šçŸ¥å®¹å™¨
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container';
        document.body.appendChild(container);
      }

      // åˆ›å»ºæ–°çš„é€šçŸ¥å…ƒç´ 
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      // æ·»åŠ æ–‡æœ¬å®¹å™¨
      toast.innerHTML = `<div class="toast-content">${message}</div>`;

      // æ·»åŠ åˆ°å®¹å™¨
      container.appendChild(toast);

      // å¼ºåˆ¶ä¸€æ¬¡é‡æ’ï¼Œç¡®ä¿è¿‡æ¸¡åŠ¨ç”»ç”Ÿæ•ˆ
      void toast.offsetWidth;

      // æ˜¾ç¤ºé€šçŸ¥ï¼Œä½¿ç”¨requestAnimationFrameç¡®ä¿å¹³æ»‘è¿‡æ¸¡
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });

      // è®¾ç½®è‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        toast.classList.remove('show');

        // é€šçŸ¥æ¶ˆå¤±åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }

          // å¦‚æœæ²¡æœ‰æ›´å¤šé€šçŸ¥ï¼Œç§»é™¤å®¹å™¨
          if (container.children.length === 0) {
            if (document.body.contains(container)) {
              document.body.removeChild(container);
            }
          }
        }, 400);
      }, duration);

      // é™åˆ¶æœ€å¤§æ˜¾ç¤ºæ•°é‡ï¼Œå¦‚æœè¶…è¿‡åˆ™ç§»é™¤æœ€æ—©çš„
      const maxToasts = 5; // æœ€å¤§åŒæ—¶æ˜¾ç¤ºçš„é€šçŸ¥æ•°
      const toasts = container.querySelectorAll('.toast');
      if (toasts.length > maxToasts) {
        const oldestToast = toasts[0]; // æœ€æ—©çš„é€šçŸ¥
        oldestToast.classList.remove('show');
        setTimeout(() => {
          if (container.contains(oldestToast)) {
            container.removeChild(oldestToast);
          }
        }, 400);
      }
    }
  </script>
</body>

</html>