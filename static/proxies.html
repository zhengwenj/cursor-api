<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;," />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä»£ç†ä¿¡æ¯ç®¡ç†</title>
  <!-- å¼•å…¥å…±äº«æ ·å¼ -->
  <link rel="stylesheet" href="/static/shared-styles.css" />
  <script src="/static/shared.js"></script>
  <style>
    /* ä»£ç†åˆ—è¡¨å¸ƒå±€æ ·å¼ */
    .proxy-system {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
      overflow: hidden;
      height: calc(100vh - 250px);
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      background: var(--card-background);
      gap: 8px;
    }

    .toolbar .search-box {
      flex: 1;
      position: relative;
    }

    .toolbar .search-box input {
      width: 100%;
      padding-left: 36px;
      padding-right: 36px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
    }

    .clear-search {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      display: none;
      min-height: auto;
      transition: all var(--transition-fast);
    }

    .clear-search:hover {
      background: var(--primary-color-alpha);
      color: var(--text-primary);
    }

    .clear-search.show {
      display: block;
    }

    .proxy-list {
      flex: 1;
      overflow: auto;
      position: relative;
      user-select: none;
      background: var(--card-background);
    }

    /* è¡¨æ ¼æ»šåŠ¨æ—¶çš„é˜´å½±æ•ˆæœ */
    .proxy-list.scrolled .proxy-table thead {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .proxy-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    .proxy-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--card-background);
      transition: box-shadow var(--transition-fast);
    }

    .proxy-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 500;
      border-bottom: 2px solid var(--border-color);
      color: var(--text-primary);
      white-space: nowrap;
    }

    .proxy-table td {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .proxy-table tbody tr {
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }

    .proxy-table tbody tr:hover {
      background: var(--primary-color-alpha);
    }

    .proxy-table tbody tr.selected {
      background: var(--primary-color-alpha);
      position: relative;
    }

    .proxy-table tbody tr.selected td:first-child {
      position: relative;
      padding-left: 20px;
    }

    .proxy-table tbody tr.selected td:first-child::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--primary-color);
    }

    .proxy-table tbody tr.general {
      font-weight: 600;
    }

    .proxy-table tbody tr.general .proxy-name::after {
      content: " â­";
      color: var(--primary-color);
    }

    /* ä»£ç†ç±»å‹å›¾æ ‡ */
    .proxy-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      margin-right: 8px;
      font-size: 16px;
    }

    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 8px 0;
      color: var(--text-primary);
    }

    .empty-state p {
      margin: 0 0 24px 0;
    }

    /* çŠ¶æ€æ  */
    .status-bar {
      padding: 8px 16px;
      background: var(--card-background);
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-info {
      display: flex;
      gap: 16px;
    }

    /* å³é”®èœå• */
    .context-menu {
      position: fixed;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 4px 0;
      z-index: 1000;
      min-width: 200px;
      display: none;
      animation: contextMenuIn 0.15s ease-out;
    }

    @keyframes contextMenuIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-primary);
    }

    .context-menu-item:hover,
    .context-menu-item:focus {
      background: var(--primary-color-alpha);
      outline: none;
    }

    .context-menu-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .context-menu-item.disabled:hover {
      background: transparent;
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }

    .context-menu-shortcut {
      margin-left: auto;
      padding-left: 16px;
      color: var(--text-secondary);
      font-size: 12px;
      opacity: 0.7;
    }

    /* ç­›é€‰é¢æ¿ */
    .filter-panel {
      padding: 16px;
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
    }

    .filter-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 250px;
    }

    /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
    .multiselect {
      position: relative;
      width: 100%;
    }

    .multiselect-dropdown {
      width: 100%;
      padding: 8px 12px;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 44px;
      transition: all var(--transition-fast);
    }

    .multiselect-dropdown:hover {
      border-color: var(--primary-color);
    }

    .multiselect-dropdown.active {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color-alpha);
    }

    .multiselect-dropdown::after {
      content: "â–¼";
      font-size: 12px;
      color: var(--text-secondary);
      transition: transform var(--transition-fast);
    }

    .multiselect-dropdown.active::after {
      transform: rotate(180deg);
    }

    .multiselect-options {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 240px;
      overflow-y: auto;
      display: none;
      animation: dropdownIn 0.2s ease-out;
    }

    @keyframes dropdownIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .multiselect-options.show {
      display: block;
    }

    .multiselect-option {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color var(--transition-fast);
    }

    .multiselect-option:hover {
      background: var(--primary-color-alpha);
    }

    .multiselect-option input[type="checkbox"] {
      margin-right: 8px;
      pointer-events: none;
    }

    .multiselect-option label {
      margin: 0;
      cursor: pointer;
      user-select: none;
      flex: 1;
    }

    .selected-options {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      flex: 1;
    }

    .selected-option {
      background: var(--primary-color-alpha);
      color: var(--primary-color);
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
    }

    .selected-options-placeholder {
      color: var(--text-secondary);
    }

    /* å¯¹è¯æ¡†æ ·å¼ */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--card-background);
      padding: 24px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      display: none;
      animation: modalIn 0.2s ease-out forwards;
    }

    @keyframes modalIn {
      to {
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .modal-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--primary-color-alpha);
      color: var(--text-primary);
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* åŠ è½½éª¨æ¶å± */
    .skeleton {
      animation: skeleton-loading 1s linear infinite alternate;
    }

    @keyframes skeleton-loading {
      0% {
        background-color: var(--border-color);
      }
      100% {
        background-color: var(--disabled-bg);
      }
    }

    .skeleton-row {
      height: 48px;
      margin-bottom: 1px;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
      }

      .filter-group {
        min-width: 100%;
      }

      .proxy-table {
        font-size: 14px;
      }

      .proxy-table th,
      .proxy-table td {
        padding: 8px 12px;
      }

      /* ç§»åŠ¨ç«¯è¡¨æ ¼ä¼˜åŒ– */
      .proxy-table thead th:nth-child(3) {
        display: none;
      }

      .proxy-table tbody td:nth-child(3) {
        display: none;
      }

      .status-info {
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
      }

      .modal {
        width: 95%;
        padding: 16px;
      }
    }

    /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
    @media (prefers-contrast: high) {
      .proxy-table tbody tr.selected td:first-child::before {
        width: 5px;
      }

      .context-menu,
      .multiselect-options {
        border-width: 2px;
      }
    }

    /* å‡å°‘åŠ¨ç”»æ¨¡å¼ */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <h1>ä»£ç†ä¿¡æ¯ç®¡ç†</h1>

  <div class="container">
    <div class="form-group">
      <label for="authToken">è®¤è¯ä»¤ç‰Œ:</label>
      <input
        type="password"
        id="authToken"
        placeholder="è¾“å…¥ AUTH_TOKEN"
        aria-label="è®¤è¯ä»¤ç‰Œ"
      />
    </div>
  </div>

  <!-- ç­›é€‰é¢æ¿ -->
  <div class="filter-panel">
    <div class="filter-row">
      <div class="filter-group">
        <label for="proxyTypeFilter">ä»£ç†ç±»å‹:</label>
        <div class="multiselect" id="proxyTypeFilter">
          <div
            class="multiselect-dropdown"
            role="button"
            tabindex="0"
            aria-haspopup="listbox"
            aria-expanded="false"
          >
            <div class="selected-options" id="selectedProxyTypes">
              <span class="selected-options-placeholder"
                >è¯·é€‰æ‹©ä»£ç†ç±»å‹...</span
              >
            </div>
          </div>
          <div
            class="multiselect-options"
            role="listbox"
            aria-multiselectable="true"
          >
            <div class="multiselect-option" role="option" data-value="non">
              <input type="checkbox" id="type-non" value="non" checked />
              <label for="type-non">ä¸ä½¿ç”¨ä»£ç†</label>
            </div>
            <div class="multiselect-option" role="option" data-value="sys">
              <input type="checkbox" id="type-sys" value="sys" checked />
              <label for="type-sys">ç³»ç»Ÿä»£ç†</label>
            </div>
            <div class="multiselect-option" role="option" data-value="http">
              <input type="checkbox" id="type-http" value="http" checked />
              <label for="type-http">HTTP</label>
            </div>
            <div class="multiselect-option" role="option" data-value="https">
              <input type="checkbox" id="type-https" value="https" checked />
              <label for="type-https">HTTPS</label>
            </div>
            <div class="multiselect-option" role="option" data-value="socks4">
              <input
                type="checkbox"
                id="type-socks4"
                value="socks4"
                checked
              />
              <label for="type-socks4">SOCKS4</label>
            </div>
            <div class="multiselect-option" role="option" data-value="socks5">
              <input
                type="checkbox"
                id="type-socks5"
                value="socks5"
                checked
              />
              <label for="type-socks5">SOCKS5</label>
            </div>
            <div
              class="multiselect-option"
              role="option"
              data-value="socks5h"
            >
              <input
                type="checkbox"
                id="type-socks5h"
                value="socks5h"
                checked
              />
              <label for="type-socks5h">SOCKS5H</label>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group">
        <label class="visually-hidden">æ“ä½œæŒ‰é’®</label>
        <div class="button-group">
          <button
            id="refreshBtn"
            onclick="getProxyInfo()"
            class="primary"
            title="åˆ·æ–°ä»£ç†åˆ—è¡¨ (F5)"
          >
            <span>åˆ·æ–°åˆ—è¡¨</span>
            <span class="context-menu-shortcut">F5</span>
          </button>
          <button
            id="addProxyBtn"
            onclick="showAddProxyModal()"
            class="secondary"
            title="æ·»åŠ æ–°ä»£ç†"
          >
            æ·»åŠ ä»£ç†
          </button>
          <button
            id="exportBtn"
            onclick="exportProxies()"
            class="secondary"
            title="å¯¼å‡ºä»£ç†é…ç½®"
          >
            å¯¼å‡ºé…ç½®
          </button>
          <button
            id="importBtn"
            onclick="showImportModal()"
            class="secondary"
            title="å¯¼å…¥ä»£ç†é…ç½®"
          >
            å¯¼å…¥é…ç½®
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ä»£ç†åˆ—è¡¨åŒºåŸŸ -->
  <div class="proxy-system">
    <div class="toolbar">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input
          type="text"
          id="searchInput"
          placeholder="æœç´¢ä»£ç†åç§°..."
          aria-label="æœç´¢ä»£ç†"
        />
        <button
          class="clear-search"
          id="clearSearch"
          onclick="clearSearchInput()"
          aria-label="æ¸…é™¤æœç´¢"
        >
          âœ•
        </button>
      </div>
    </div>

    <div class="proxy-list" id="proxyListContainer">
      <table class="proxy-table" role="table">
        <thead>
          <tr role="row">
            <th role="columnheader" style="width: 30%">ä»£ç†åç§°</th>
            <th role="columnheader" style="width: 25%">ä»£ç†ç±»å‹</th>
            <th role="columnheader" style="width: 45%">ä»£ç†åœ°å€</th>
          </tr>
        </thead>
        <tbody id="proxyListBody" role="rowgroup">
          <!-- åŠ¨æ€ç”Ÿæˆçš„ä»£ç†åˆ—è¡¨ -->
        </tbody>
      </table>
      <div id="emptyState" class="empty-state" style="display: none">
        <div class="empty-state-icon">ğŸŒ</div>
        <h3>æ²¡æœ‰æ‰¾åˆ°ä»£ç†</h3>
        <p>è¯·æ·»åŠ ä»£ç†æˆ–æ›´æ”¹ç­›é€‰æ¡ä»¶</p>
        <button onclick="showAddProxyModal()" class="primary">
          æ·»åŠ ä»£ç†
        </button>
      </div>
      <div id="loadingState" class="skeleton" style="display: none">
        <div class="skeleton-row skeleton"></div>
        <div class="skeleton-row skeleton"></div>
        <div class="skeleton-row skeleton"></div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-info">
        <span id="selectionStatus">å·²é€‰æ‹©: 0 ä¸ª</span>
        <span id="totalCount">å…± 0 ä¸ªä»£ç†</span>
      </div>
    </div>
  </div>

  <!-- å³é”®èœå• -->
  <div id="contextMenu" class="context-menu" role="menu">
    <div
      class="context-menu-item"
      onclick="setAsGeneral()"
      role="menuitem"
      tabindex="0"
    >
      <span>è®¾ä¸ºé€šç”¨ä»£ç†</span>
      <span class="context-menu-shortcut">Ctrl+G</span>
    </div>
    <div
      class="context-menu-item"
      onclick="copyProxyUrl()"
      role="menuitem"
      tabindex="0"
    >
      <span>å¤åˆ¶ä»£ç†åœ°å€</span>
      <span class="context-menu-shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-divider" role="separator"></div>
    <div
      class="context-menu-item"
      onclick="deleteSelectedProxies()"
      role="menuitem"
      tabindex="0"
    >
      <span>åˆ é™¤</span>
      <span class="context-menu-shortcut">Delete</span>
    </div>
  </div>

  <!-- æ·»åŠ ä»£ç†å¯¹è¯æ¡† -->
  <div
    class="modal-backdrop"
    id="addProxyModal-backdrop"
    onclick="closeModal('addProxyModal')"
  ></div>
  <div
    class="modal"
    id="addProxyModal"
    role="dialog"
    aria-labelledby="addProxyTitle"
    aria-modal="true"
  >
    <div class="modal-header">
      <h3 id="addProxyTitle">æ·»åŠ ä»£ç†</h3>
      <button
        class="modal-close"
        onclick="closeModal('addProxyModal')"
        aria-label="å…³é—­å¯¹è¯æ¡†"
      >
        Ã—
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="proxyName">ä»£ç†åç§°:</label>
        <input
          type="text"
          id="proxyName"
          placeholder="è¾“å…¥ä»£ç†åç§°"
          required
        />
      </div>
      <div class="form-group">
        <label for="proxyType">ä»£ç†ç±»å‹:</label>
        <select id="proxyType" onchange="toggleProxyUrl()">
          <option value="non">ä¸ä½¿ç”¨ä»£ç†</option>
          <option value="sys">ç³»ç»Ÿä»£ç†</option>
          <option value="custom" selected>è‡ªå®šä¹‰ä»£ç†</option>
        </select>
      </div>
      <div class="form-group" id="proxyUrlGroup">
        <label for="proxyUrl">ä»£ç†åœ°å€:</label>
        <input
          type="text"
          id="proxyUrl"
          placeholder="ä¾‹å¦‚: http://localhost:7890"
        />
        <div class="help-text">
          æ”¯æŒçš„æ ¼å¼: http://localhost:7890,
          socks5://username:password@localhost:1080
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('addProxyModal')" class="secondary">
        å–æ¶ˆ
      </button>
      <button onclick="confirmAddProxy()" class="primary">æ·»åŠ </button>
    </div>
  </div>

  <!-- ç¡®è®¤åˆ é™¤å¯¹è¯æ¡† -->
  <div
    class="modal-backdrop"
    id="confirmModal-backdrop"
    onclick="closeModal('confirmModal')"
  ></div>
  <div
    class="modal"
    id="confirmModal"
    role="dialog"
    aria-labelledby="confirmTitle"
    aria-modal="true"
  >
    <div class="modal-header">
      <h3 id="confirmTitle">ç¡®è®¤åˆ é™¤</h3>
      <button
        class="modal-close"
        onclick="closeModal('confirmModal')"
        aria-label="å…³é—­å¯¹è¯æ¡†"
      >
        Ã—
      </button>
    </div>
    <div class="modal-body">
      <p id="confirmMessage">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ä»£ç†å—ï¼Ÿ</p>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('confirmModal')" class="secondary">
        å–æ¶ˆ
      </button>
      <button onclick="confirmDeleteProxies()" class="danger">åˆ é™¤</button>
    </div>
  </div>

  <!-- å¯¼å…¥å¯¹è¯æ¡† -->
  <div
    class="modal-backdrop"
    id="importModal-backdrop"
    onclick="closeModal('importModal')"
  ></div>
  <div
    class="modal"
    id="importModal"
    role="dialog"
    aria-labelledby="importTitle"
    aria-modal="true"
  >
    <div class="modal-header">
      <h3 id="importTitle">å¯¼å…¥ä»£ç†é…ç½®</h3>
      <button
        class="modal-close"
        onclick="closeModal('importModal')"
        aria-label="å…³é—­å¯¹è¯æ¡†"
      >
        Ã—
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="importFile">é€‰æ‹©JSONæ–‡ä»¶:</label>
        <input
          type="file"
          id="importFile"
          accept=".json"
          onchange="previewImportFile()"
        />
      </div>
      <div id="importPreview" style="display: none; margin-top: 16px">
        <h4>æ–‡ä»¶é¢„è§ˆ:</h4>
        <pre
          id="importPreviewContent"
          style="
            background: var(--disabled-bg);
            padding: 12px;
            border-radius: 4px;
            overflow: auto;
            max-height: 200px;
          "
        ></pre>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('importModal')" class="secondary">
        å–æ¶ˆ
      </button>
      <button
        id="confirmImportBtn"
        onclick="confirmImport()"
        class="primary"
        disabled
      >
        å¯¼å…¥
      </button>
    </div>
  </div>

  <!-- å…¨å±€é€šçŸ¥åŒºåŸŸ -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // å…¨å±€å˜é‡
    let allProxies = {};
    let generalProxy = "";
    let selectedProxies = new Set();
    let proxiesToDelete = [];
    let searchDebounceTimer = null;

    // åˆå§‹åŒ–TokenHandling
    initializeTokenHandling("authToken");

    // åˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", () => {
      // è·å–ä»£ç†ä¿¡æ¯
      getProxyInfo();

      // ç›‘å¬æœç´¢è¾“å…¥ï¼ˆé˜²æŠ–ï¼‰
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", (e) => {
        clearTimeout(searchDebounceTimer);
        const value = e.target.value;

        // æ˜¾ç¤º/éšè—æ¸…é™¤æŒ‰é’®
        const clearBtn = document.getElementById("clearSearch");
        clearBtn.classList.toggle("show", value.length > 0);

        // é˜²æŠ–æœç´¢
        searchDebounceTimer = setTimeout(() => {
          filterProxies();
        }, 300);
      });

      // ç›‘å¬ä»£ç†åˆ—è¡¨æ»šåŠ¨
      const proxyListContainer =
        document.getElementById("proxyListContainer");
      proxyListContainer.addEventListener("scroll", () => {
        const scrolled = proxyListContainer.scrollTop > 0;
        proxyListContainer.classList.toggle("scrolled", scrolled);
      });

      // åˆå§‹åŒ–å¤šé€‰ä¸‹æ‹‰æ¡†
      initMultiSelect();

      // è®¾ç½®é”®ç›˜å¿«æ·é”®
      setupKeyboardShortcuts();

      // è®¾ç½®ä¸Šä¸‹æ–‡èœå•
      setupContextMenu();

      updateStatusBar();
    });

    // åˆå§‹åŒ–å¤šé€‰ä¸‹æ‹‰æ¡†
    function initMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      // ç‚¹å‡»ä¸‹æ‹‰æ¡†æ˜¾ç¤º/éšè—é€‰é¡¹
      dropdown.addEventListener("click", function (e) {
        e.stopPropagation();
        const isOpen = dropdown.classList.contains("active");

        if (isOpen) {
          closeMultiSelect();
        } else {
          openMultiSelect();
        }
      });

      // é”®ç›˜å¯¼èˆªæ”¯æŒ
      dropdown.addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          dropdown.click();
        }
      });

      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
      document.addEventListener("click", function (e) {
        if (!e.target.closest(".multiselect")) {
          closeMultiSelect();
        }
      });

      // ç›‘å¬é€‰é¡¹ç‚¹å‡»
      const optionDivs = document.querySelectorAll(".multiselect-option");
      optionDivs.forEach((div) => {
        div.addEventListener("click", function (e) {
          e.stopPropagation();
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event("change"));
        });

        // ç›‘å¬å¤é€‰æ¡†å˜åŒ–
        const checkbox = div.querySelector('input[type="checkbox"]');
        checkbox.addEventListener("change", function () {
          updateSelectedOptions();
          filterProxies();
        });
      });

      // åˆå§‹åŒ–å·²é€‰é¡¹
      updateSelectedOptions();
    }

    // æ‰“å¼€å¤šé€‰ä¸‹æ‹‰æ¡†
    function openMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      dropdown.classList.add("active");
      dropdown.setAttribute("aria-expanded", "true");
      options.classList.add("show");
    }

    // å…³é—­å¤šé€‰ä¸‹æ‹‰æ¡†
    function closeMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      dropdown.classList.remove("active");
      dropdown.setAttribute("aria-expanded", "false");
      options.classList.remove("show");
    }

    // æ›´æ–°å·²é€‰é€‰é¡¹æ˜¾ç¤º
    function updateSelectedOptions() {
      const selectedContainer = document.getElementById("selectedProxyTypes");
      const checkboxes = document.querySelectorAll(
        ".multiselect-option input:checked",
      );

      if (checkboxes.length === 0) {
        selectedContainer.innerHTML =
          '<span class="selected-options-placeholder">è¯·é€‰æ‹©ä»£ç†ç±»å‹...</span>';
        return;
      }

      let html = "";
      checkboxes.forEach((checkbox) => {
        const label = checkbox.nextElementSibling.textContent;
        html += `<span class="selected-option">${label}</span>`;
      });

      selectedContainer.innerHTML = html;
    }

    // æ¸…é™¤æœç´¢è¾“å…¥
    function clearSearchInput() {
      const searchInput = document.getElementById("searchInput");
      const clearBtn = document.getElementById("clearSearch");

      searchInput.value = "";
      clearBtn.classList.remove("show");
      filterProxies();
      searchInput.focus();
    }

    // æ£€æµ‹æ˜¯Macè¿˜æ˜¯å…¶ä»–ç³»ç»Ÿ
    function isModifierKey(e) {
      const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
      return isMac ? e.metaKey : e.ctrlKey;
    }

    // è®¾ç½®é”®ç›˜å¿«æ·é”®
    function setupKeyboardShortcuts() {
      document.addEventListener("keydown", function (e) {
        // å¿½ç•¥è¾“å…¥æ¡†ä¸­çš„å¿«æ·é”®
        if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") {
          return;
        }

        switch (e.key) {
          case "Delete":
            e.preventDefault();
            deleteSelectedProxies();
            break;
          case "F5":
            e.preventDefault();
            getProxyInfo();
            break;
          case "g":
            if (isModifierKey(e)) {
              e.preventDefault();
              setAsGeneral();
            }
            break;
          case "c":
            if (isModifierKey(e)) {
              e.preventDefault();
              copyProxyUrl();
            }
            break;
          case "a":
            if (isModifierKey(e)) {
              e.preventDefault();
              selectAllProxies();
            }
            break;
          case "Escape":
            closeAllModals();
            closeContextMenu();
            closeMultiSelect();
            break;
        }
      });
    }

    // è®¾ç½®ä¸Šä¸‹æ–‡èœå•
    function setupContextMenu() {
      const proxyList = document.querySelector(".proxy-list");
      const contextMenu = document.getElementById("contextMenu");

      // å³é”®ç‚¹å‡»æ˜¾ç¤ºèœå•
      proxyList.addEventListener("contextmenu", function (e) {
        const row = e.target.closest("tr");

        if (!row || row.closest("thead")) return;
        if (!row.dataset.name) return;

        e.preventDefault();

        const proxyName = row.dataset.name;

        if (!selectedProxies.has(proxyName)) {
          clearSelection();
          selectProxy(proxyName);
        }

        updateContextMenuItems();
        showContextMenu(e.pageX, e.pageY);
      });

      // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
      document.addEventListener("click", function () {
        closeContextMenu();
      });

      // é˜»æ­¢å³é”®èœå•å†…éƒ¨ç‚¹å‡»å¯¼è‡´èœå•å…³é—­
      contextMenu.addEventListener("click", function (e) {
        e.stopPropagation();
      });

      // é”®ç›˜å¯¼èˆªæ”¯æŒ
      setupContextMenuKeyboardNav();
    }

    // è®¾ç½®å³é”®èœå•é”®ç›˜å¯¼èˆª
    function setupContextMenuKeyboardNav() {
      const contextMenu = document.getElementById("contextMenu");
      const items = contextMenu.querySelectorAll(
        ".context-menu-item:not(.disabled)",
      );

      items.forEach((item, index) => {
        item.addEventListener("keydown", function (e) {
          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              const nextIndex = (index + 1) % items.length;
              items[nextIndex].focus();
              break;
            case "ArrowUp":
              e.preventDefault();
              const prevIndex = (index - 1 + items.length) % items.length;
              items[prevIndex].focus();
              break;
            case "Enter":
            case " ":
              e.preventDefault();
              item.click();
              break;
            case "Escape":
              e.preventDefault();
              closeContextMenu();
              break;
          }
        });
      });
    }

    // æ˜¾ç¤ºå³é”®èœå•
    function showContextMenu(x, y) {
      const menu = document.getElementById("contextMenu");

      // å…ˆè®¾ç½®åœ¨é¼ æ ‡ä½ç½®ï¼Œç„¶åè°ƒæ•´é¿å…è¶…å‡ºè¾¹ç•Œ
      menu.style.left = x + "px";
      menu.style.top = y + "px";
      menu.style.display = "block";

      // è°ƒæ•´ä½ç½®ä»¥é¿å…è¶…å‡ºè¾¹ç•Œ
      positionContextMenu(menu, x, y);

      // èšç„¦ç¬¬ä¸€ä¸ªå¯ç”¨é¡¹
      const firstItem = menu.querySelector(
        ".context-menu-item:not(.disabled)",
      );
      if (firstItem) {
        firstItem.focus();
      }
    }

    // å…³é—­å³é”®èœå•
    function closeContextMenu() {
      const contextMenu = document.getElementById("contextMenu");
      contextMenu.style.display = "none";
    }

    // æ›´æ–°å³é”®èœå•é¡¹çŠ¶æ€
    function updateContextMenuItems() {
      const selectedCount = selectedProxies.size;
      const items = document.querySelectorAll(".context-menu-item");

      items.forEach((item) => {
        // æ ¹æ®é€‰æ‹©çŠ¶æ€å¯ç”¨/ç¦ç”¨èœå•é¡¹
        if (item.onclick.toString().includes("setAsGeneral")) {
          item.classList.toggle("disabled", selectedCount !== 1);
        }
      });
    }

    // è®¡ç®—èœå•ä½ç½®
    function positionContextMenu(menu, x, y) {
      menu.style.visibility = "hidden";
      menu.style.display = "block";

      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      const menuWidth = menu.offsetWidth;
      const menuHeight = menu.offsetHeight;

      let adjustedX = x;
      let adjustedY = y;

      if (x + menuWidth > windowWidth - 10) {
        adjustedX = windowWidth - menuWidth - 10;
      }

      if (y + menuHeight > windowHeight - 10) {
        adjustedY = windowHeight - menuHeight - 10;
      }

      menu.style.left = Math.max(10, adjustedX) + "px";
      menu.style.top = Math.max(10, adjustedY) + "px";
      menu.style.visibility = "visible";
    }

    // è·å–ä»£ç†ä¿¡æ¯
    async function getProxyInfo() {
      showLoadingState();
      showToast("æ­£åœ¨åŠ è½½ä»£ç†åˆ—è¡¨...", "info");

      const data = await makeAuthenticatedRequest("/proxies/get");

      if (data) {
        allProxies = data.proxies || {};
        generalProxy = data.general_proxy || "";
        renderProxies();
        updateStatusBar();
        showToast(
          `ä»£ç†åˆ—è¡¨å·²æ›´æ–°ï¼šå…± ${data.proxies_count || 0} ä¸ª`,
          "success",
        );
      } else {
        showToast("è·å–ä»£ç†åˆ—è¡¨å¤±è´¥", "error");
        hideLoadingState();
      }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoadingState() {
      const loadingState = document.getElementById("loadingState");
      const emptyState = document.getElementById("emptyState");
      const proxyListBody = document.getElementById("proxyListBody");

      loadingState.style.display = "block";
      emptyState.style.display = "none";
      proxyListBody.innerHTML = "";
    }

    // éšè—åŠ è½½çŠ¶æ€
    function hideLoadingState() {
      const loadingState = document.getElementById("loadingState");
      loadingState.style.display = "none";
    }

    // æ¸²æŸ“ä»£ç†åˆ—è¡¨
    function renderProxies() {
      const proxyListBody = document.getElementById("proxyListBody");
      const emptyState = document.getElementById("emptyState");
      const loadingState = document.getElementById("loadingState");

      loadingState.style.display = "none";

      const proxyEntries = Object.entries(allProxies);

      if (proxyEntries.length === 0) {
        proxyListBody.innerHTML = "";
        emptyState.style.display = "flex";
        return;
      }

      emptyState.style.display = "none";

      proxyListBody.innerHTML = proxyEntries
        .map(([name, value]) => {
          const isGeneral = name === generalProxy;
          const type = getProxyType(value);
          const url = type === "non" || type === "sys" ? "-" : value;
          const icon = getProxyIcon(type);

          return `
        <tr role="row" data-name="${escapeHtml(name)}" class="${selectedProxies.has(name) ? "selected" : ""} ${isGeneral ? "general" : ""}">
          <td><span class="proxy-icon">${icon}</span><span class="proxy-name">${escapeHtml(name)}</span></td>
          <td>${formatProxyType(type)}</td>
          <td>${escapeHtml(url)}</td>
        </tr>
      `;
        })
        .join("");

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
      setupProxyRowEvents();
    }

    // è®¾ç½®ä»£ç†è¡Œäº‹ä»¶
    function setupProxyRowEvents() {
      const rows = document.querySelectorAll("#proxyListBody tr");
      rows.forEach((row) => {
        row.addEventListener("click", function (e) {
          const name = this.dataset.name;

          if (e.shiftKey && selectedProxies.size > 0) {
            // Shift+ç‚¹å‡»è¿›è¡ŒèŒƒå›´é€‰æ‹©
            selectRange(name);
          } else if (isModifierKey(e)) {
            // Ctrl/Cmd+ç‚¹å‡»è¿›è¡Œå¤šé€‰
            if (selectedProxies.has(name)) {
              deselectProxy(name);
            } else {
              selectProxy(name, true);
            }
          } else {
            // æ™®é€šç‚¹å‡»
            clearSelection();
            selectProxy(name);
          }

          updateSelectionStatus();
        });
      });
    }

    // é€‰æ‹©èŒƒå›´å†…çš„ä»£ç†
    function selectRange(endName) {
      const rows = Array.from(document.querySelectorAll("#proxyListBody tr"));
      const lastSelected = Array.from(selectedProxies).pop();

      const startIndex = rows.findIndex(
        (row) => row.dataset.name === lastSelected,
      );
      const endIndex = rows.findIndex((row) => row.dataset.name === endName);

      if (startIndex === -1 || endIndex === -1) return;

      const [min, max] = [
        Math.min(startIndex, endIndex),
        Math.max(startIndex, endIndex),
      ];

      for (let i = min; i <= max; i++) {
        const name = rows[i].dataset.name;
        selectProxy(name, true);
      }
    }

    // é€‰æ‹©æ‰€æœ‰ä»£ç†
    function selectAllProxies() {
      const rows = document.querySelectorAll("#proxyListBody tr");
      rows.forEach((row) => {
        const name = row.dataset.name;
        selectProxy(name, true);
      });
      updateSelectionStatus();
    }

    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // è·å–ä»£ç†å›¾æ ‡
    function getProxyIcon(type) {
      const icons = {
        non: "ğŸš«",
        sys: "ğŸ–¥ï¸",
        http: "ğŸŒ",
        https: "ğŸ”’",
        socks4: "ğŸ§¦",
        socks5: "ğŸ§¦",
        socks5h: "ğŸ§¦",
        unknown: "â“",
      };
      return icons[type] || icons.unknown;
    }

    // è·å–ä»£ç†ç±»å‹
    function getProxyType(value) {
      if (value === "non") return "non";
      if (value === "sys") return "sys";
      try {
        const proxyUrl = new URL(value);
        const protocol = proxyUrl.protocol.replace(":", "");
        return protocol;
      } catch (e) {
        return "unknown";
      }
    }

    // æ ¼å¼åŒ–ä»£ç†ç±»å‹
    function formatProxyType(type) {
      const types = {
        non: "ä¸ä½¿ç”¨ä»£ç†",
        sys: "ç³»ç»Ÿä»£ç†",
        http: "HTTP",
        https: "HTTPS",
        socks4: "SOCKS4",
        socks5: "SOCKS5",
        socks5h: "SOCKS5H",
        unknown: "æœªçŸ¥",
      };
      return types[type] || type;
    }

    // éªŒè¯ä»£ç†åœ°å€æ ¼å¼
    function validateProxyUrl(url, type) {
      if (type === "non" || type === "sys") return true;

      try {
        const proxyUrl = new URL(url);
        const protocol = proxyUrl.protocol.replace(":", "");

        const validProtocols = [
          "http",
          "https",
          "socks4",
          "socks5",
          "socks5h",
        ];
        if (!validProtocols.includes(protocol)) {
          showToast(`ä¸æ”¯æŒçš„ä»£ç†åè®®: ${protocol}`, "warning");
          return false;
        }

        if (!proxyUrl.hostname || !proxyUrl.port) {
          showToast("ä»£ç†åœ°å€å¿…é¡»åŒ…å«ä¸»æœºåå’Œç«¯å£å·", "warning");
          return false;
        }

        return true;
      } catch (e) {
        showToast("ä»£ç†åœ°å€æ ¼å¼æ— æ•ˆ", "warning");
        return false;
      }
    }

    // ç­›é€‰ä»£ç†
    function filterProxies() {
      const searchTerm = document
        .getElementById("searchInput")
        .value.toLowerCase();
      const selectedTypes = Array.from(
        document.querySelectorAll(".multiselect-option input:checked"),
      ).map((cb) => cb.value);

      const filteredProxies = Object.entries(allProxies).filter(
        ([name, value]) => {
          const type = getProxyType(value);
          const nameMatch = name.toLowerCase().includes(searchTerm);
          const typeMatch = selectedTypes.includes(type);

          return nameMatch && typeMatch;
        },
      );

      const filteredObj = Object.fromEntries(filteredProxies);
      renderFilteredProxies(filteredObj);
      updateStatusBar(filteredProxies.length);
    }

    // æ¸²æŸ“ç­›é€‰åçš„ä»£ç†
    function renderFilteredProxies(proxies) {
      const temp = allProxies;
      allProxies = proxies;
      renderProxies();
      allProxies = temp;
    }

    // æ›´æ–°çŠ¶æ€æ 
    function updateStatusBar(filteredCount) {
      const total = Object.keys(allProxies).length;
      const selected = selectedProxies.size;
      const selectionStatus = document.getElementById("selectionStatus");
      const totalCount = document.getElementById("totalCount");

      if (selectionStatus) {
        selectionStatus.textContent = `å·²é€‰æ‹©: ${selected} ä¸ª`;
      }
      if (totalCount) {
        const count = filteredCount !== undefined ? filteredCount : total;
        totalCount.textContent = `å…± ${count} ä¸ªä»£ç†`;
      }
    }

    // é€‰æ‹©ä»£ç†
    function selectProxy(name, append = false) {
      if (!name) return;

      if (!append) {
        clearSelection();
      }

      selectedProxies.add(name);
      const row = document.querySelector(`tr[data-name="${name}"]`);
      if (row) {
        row.classList.add("selected");
      }

      updateSelectionStatus();
    }

    // å–æ¶ˆé€‰æ‹©ä»£ç†
    function deselectProxy(name) {
      if (!name) return;

      selectedProxies.delete(name);
      const row = document.querySelector(`tr[data-name="${name}"]`);
      if (row) {
        row.classList.remove("selected");
      }

      updateSelectionStatus();
    }

    // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
    function clearSelection() {
      selectedProxies.clear();
      const rows = document.querySelectorAll("#proxyListBody tr.selected");
      rows.forEach((row) => {
        row.classList.remove("selected");
      });

      updateSelectionStatus();
    }

    // æ›´æ–°é€‰æ‹©çŠ¶æ€
    function updateSelectionStatus() {
      updateStatusBar();
    }

    // æ˜¾ç¤ºæ·»åŠ ä»£ç†å¯¹è¯æ¡†
    function showAddProxyModal() {
      document.getElementById("proxyName").value = "";
      document.getElementById("proxyType").value = "custom";
      document.getElementById("proxyUrl").value = "";
      toggleProxyUrl();
      showModal("addProxyModal");

      // èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
      setTimeout(() => {
        document.getElementById("proxyName").focus();
      }, 200);
    }

    // åˆ‡æ¢ä»£ç†åœ°å€è¾“å…¥æ¡†æ˜¾ç¤º
    function toggleProxyUrl() {
      const type = document.getElementById("proxyType").value;
      const urlGroup = document.getElementById("proxyUrlGroup");
      urlGroup.style.display = type === "custom" ? "block" : "none";
    }

    // ç¡®è®¤æ·»åŠ ä»£ç†
    async function confirmAddProxy() {
      const name = document.getElementById("proxyName").value.trim();
      const type = document.getElementById("proxyType").value;
      const url = document.getElementById("proxyUrl").value.trim();

      if (!name) {
        showToast("è¯·è¾“å…¥ä»£ç†åç§°", "warning");
        document.getElementById("proxyName").focus();
        return;
      }

      if (type === "custom") {
        if (!url) {
          showToast("è¯·è¾“å…¥ä»£ç†åœ°å€", "warning");
          document.getElementById("proxyUrl").focus();
          return;
        }

        if (!validateProxyUrl(url, type)) {
          return;
        }
      }

      closeModal("addProxyModal");
      showToast("æ­£åœ¨æ·»åŠ ä»£ç†...", "info");

      const proxy = {
        [name]: type === "non" || type === "sys" ? type : url,
      };

      const data = await makeAuthenticatedRequest("/proxies/add", {
        body: JSON.stringify({
          proxies: proxy,
        }),
      });

      if (data) {
        showToast(data.message || "æ·»åŠ æˆåŠŸ", "success");
        getProxyInfo();
      } else {
        showToast("æ·»åŠ ä»£ç†å¤±è´¥", "error");
      }
    }

    // åˆ é™¤é€‰ä¸­çš„ä»£ç†
    function deleteSelectedProxies() {
      if (selectedProxies.size === 0) {
        showToast("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä»£ç†", "info");
        return;
      }

      proxiesToDelete = [...selectedProxies];
      document.getElementById("confirmMessage").textContent =
        proxiesToDelete.length > 1
          ? `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${proxiesToDelete.length} ä¸ªä»£ç†å—ï¼Ÿ`
          : "ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ä»£ç†å—ï¼Ÿ";

      closeContextMenu();
      showModal("confirmModal");
    }

    // ç¡®è®¤åˆ é™¤ä»£ç†
    async function confirmDeleteProxies() {
      if (proxiesToDelete.length === 0) return;

      closeModal("confirmModal");
      showToast("æ­£åœ¨åˆ é™¤ä»£ç†...", "info");

      const data = await makeAuthenticatedRequest("/proxies/del", {
        body: JSON.stringify({
          names: proxiesToDelete,
          expectation: "failed_tokens",
        }),
      });

      if (data) {
        const failedCount = data.failed_names?.length || 0;
        const successCount = proxiesToDelete.length - failedCount;
        const message = failedCount
          ? `åˆ é™¤æˆåŠŸ: ${successCount} ä¸ªï¼Œå¤±è´¥: ${failedCount} ä¸ª`
          : `æˆåŠŸåˆ é™¤ ${successCount} ä¸ªä»£ç†`;

        showToast(message, "success");
        clearSelection();
        getProxyInfo();
      } else {
        showToast("åˆ é™¤ä»£ç†å¤±è´¥", "error");
      }

      proxiesToDelete = [];
    }

    // è®¾ç½®ä¸ºé€šç”¨ä»£ç†
    async function setAsGeneral() {
      if (selectedProxies.size !== 1) {
        showToast("è¯·é€‰æ‹©ä¸€ä¸ªä»£ç†è®¾ä¸ºé€šç”¨ä»£ç†", "info");
        return;
      }

      closeContextMenu();

      const name = [...selectedProxies][0];
      showToast("æ­£åœ¨è®¾ç½®é€šç”¨ä»£ç†...", "info");

      const data = await makeAuthenticatedRequest("/proxies/set-general", {
        body: JSON.stringify({
          name: name,
        }),
      });

      if (data) {
        showToast("é€šç”¨ä»£ç†è®¾ç½®æˆåŠŸ", "success");
        getProxyInfo();
      } else {
        showToast("è®¾ç½®é€šç”¨ä»£ç†å¤±è´¥", "error");
      }
    }

    // å¤åˆ¶ä»£ç†åœ°å€
    async function copyProxyUrl() {
      if (selectedProxies.size === 0) {
        showToast("è¯·å…ˆé€‰æ‹©ä»£ç†", "info");
        return;
      }

      const name = [...selectedProxies][0];
      const value = allProxies[name];

      closeContextMenu();

      if (typeof value === "string" && value !== "non" && value !== "sys") {
        // ä½¿ç”¨å…±äº«çš„å¤åˆ¶æ–¹æ³•
        const success = await copyToClipboard(value, {
          showMessage: false, // ä½¿ç”¨è‡ªå®šä¹‰çš„ toast æ¶ˆæ¯
          onSuccess: () => {
            showToast("ä»£ç†åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
          },
          onError: () => {
            showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶", "error");
          },
        });
      } else {
        showToast("è¯¥ä»£ç†æ²¡æœ‰å¯å¤åˆ¶çš„åœ°å€", "warning");
      }
    }

    // å¯¼å‡ºä»£ç†é…ç½®
    function exportProxies() {
      const config = {
        proxies: allProxies,
        general: generalProxy,
      };

      const jsonData = JSON.stringify(config, null, 2);
      const blob = new Blob([jsonData], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `proxies_export_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast("ä»£ç†é…ç½®å·²å¯¼å‡º", "success");
    }

    // æ˜¾ç¤ºå¯¼å…¥å¯¹è¯æ¡†
    function showImportModal() {
      document.getElementById("importFile").value = "";
      document.getElementById("importPreview").style.display = "none";
      document.getElementById("confirmImportBtn").disabled = true;
      showModal("importModal");
    }

    // é¢„è§ˆå¯¼å…¥æ–‡ä»¶
    function previewImportFile() {
      const fileInput = document.getElementById("importFile");
      const preview = document.getElementById("importPreview");
      const previewContent = document.getElementById("importPreviewContent");
      const confirmBtn = document.getElementById("confirmImportBtn");

      if (!fileInput.files || fileInput.files.length === 0) {
        preview.style.display = "none";
        confirmBtn.disabled = true;
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          const config = JSON.parse(e.target.result);

          // éªŒè¯æ–‡ä»¶æ ¼å¼
          if (!config.proxies || typeof config.proxies !== "object") {
            throw new Error("æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼");
          }

          // æ˜¾ç¤ºé¢„è§ˆ
          const proxyCount = Object.keys(config.proxies).length;
          const previewText = `ä»£ç†æ•°é‡: ${proxyCount}\né€šç”¨ä»£ç†: ${config.general || "æ— "}\n\nä»£ç†åˆ—è¡¨:\n${Object.entries(
            config.proxies,
          )
            .slice(0, 10)
            .map(([name, value]) => `- ${name}: ${value}`)
            .join("\n")}${proxyCount > 10 ? "\n..." : ""}`;

          previewContent.textContent = previewText;
          preview.style.display = "block";
          confirmBtn.disabled = false;
        } catch (error) {
          showToast("æ–‡ä»¶æ ¼å¼æ— æ•ˆ: " + error.message, "error");
          preview.style.display = "none";
          confirmBtn.disabled = true;
        }
      };

      reader.readAsText(file);
    }

    // ç¡®è®¤å¯¼å…¥
    async function confirmImport() {
      const fileInput = document.getElementById("importFile");

      if (!fileInput.files || fileInput.files.length === 0) {
        showToast("è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶", "warning");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function (e) {
        try {
          const config = JSON.parse(e.target.result);

          closeModal("importModal");
          showToast("æ­£åœ¨å¯¼å…¥ä»£ç†é…ç½®...", "info");

          const data = await makeAuthenticatedRequest("/proxies/set", {
            body: JSON.stringify(config),
          });

          if (data) {
            showToast("ä»£ç†é…ç½®å¯¼å…¥æˆåŠŸ", "success");
            fileInput.value = "";
            getProxyInfo();
          } else {
            showToast("å¯¼å…¥å¤±è´¥", "error");
          }
        } catch (error) {
          showToast("å¯¼å…¥å¤±è´¥: " + error.message, "error");
        }
      };

      reader.readAsText(file);
    }

    // æ˜¾ç¤ºå¯¹è¯æ¡†
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = "block";
        backdrop.style.display = "block";
      }
    }

    // å…³é—­å¯¹è¯æ¡†
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = "none";
        backdrop.style.display = "none";
      }
    }

    // å…³é—­æ‰€æœ‰å¯¹è¯æ¡†
    function closeAllModals() {
      const modals = document.querySelectorAll(".modal");
      const backdrops = document.querySelectorAll(".modal-backdrop");

      modals.forEach((modal) => {
        modal.style.display = "none";
      });

      backdrops.forEach((backdrop) => {
        backdrop.style.display = "none";
      });
    }

    // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
    function showToast(message, type = "info", duration = 3000) {
      // è·å–æˆ–åˆ›å»ºé€šçŸ¥å®¹å™¨
      let container = document.getElementById("toast-container");
      if (!container) {
        container = document.createElement("div");
        container.id = "toast-container";
        container.className = "toast-container";
        document.body.appendChild(container);
      }

      // åˆ›å»ºæ–°çš„é€šçŸ¥å…ƒç´ 
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;

      // æ·»åŠ æ–‡æœ¬å®¹å™¨
      toast.innerHTML = `<div class="toast-content">${message}</div>`;

      // æ·»åŠ åˆ°å®¹å™¨
      container.appendChild(toast);

      // å¼ºåˆ¶ä¸€æ¬¡é‡æ’ï¼Œç¡®ä¿è¿‡æ¸¡åŠ¨ç”»ç”Ÿæ•ˆ
      void toast.offsetWidth;

      // æ˜¾ç¤ºé€šçŸ¥
      requestAnimationFrame(() => {
        toast.classList.add("show");
      });

      // è®¾ç½®è‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        toast.classList.remove("show");

        // é€šçŸ¥æ¶ˆå¤±åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }

          // å¦‚æœæ²¡æœ‰æ›´å¤šé€šçŸ¥ï¼Œç§»é™¤å®¹å™¨
          if (container.children.length === 0) {
            if (document.body.contains(container)) {
              document.body.removeChild(container);
            }
          }
        }, 400);
      }, duration);

      // é™åˆ¶æœ€å¤§æ˜¾ç¤ºæ•°é‡
      const maxToasts = 5;
      const toasts = container.querySelectorAll(".toast");
      if (toasts.length > maxToasts) {
        const oldestToast = toasts[0];
        oldestToast.classList.remove("show");
        setTimeout(() => {
          if (container.contains(oldestToast)) {
            container.removeChild(oldestToast);
          }
        }, 400);
      }
    }
  </script>
</body>
</html>