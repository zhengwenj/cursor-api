<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;,">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API ç®¡ç†</title>
  <link rel="stylesheet" href="/static/shared-styles.css">
  <script src="/static/shared.js"></script>
  <style>
    .status-healthy {
      color: var(--success-color);
      animation: pulse 2s infinite;
    }

    .status-error {
      color: var(--error-color);
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.6;
      }

      100% {
        opacity: 1;
      }
    }

    .footer {
      margin-top: 2rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-align: center;
    }

    .copy-button {
      position: absolute;
      right: 0px;
      top: 0px;
      padding: 4px;
      background: transparent;
      min-height: auto;
    }

    .model-input-container {
      position: relative;
    }

    .custom-suffix {
      margin-top: 1rem;
    }

    .progress-container {
      margin-top: 1rem;
    }

    .usage-progress-container {
      width: 100%;
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      margin: 8px 0;
      overflow: hidden;
    }

    .usage-progress-bar {
      height: 100%;
      transition: width 0.3s ease;
    }

    .progress-low {
      background: var(--success-color);
    }

    .progress-medium {
      background: #FFA726;
    }

    .progress-high {
      background: var(--error-color);
    }

    .usage-progress-bar.unlimited {
      background: repeating-linear-gradient(45deg,
          var(--success-color),
          var(--success-color) 10px,
          transparent 10px,
          transparent 20px);
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .copy-button {
        width: auto !important;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h1>API ç®¡ç†</h1>
      <div id="serverStatus" class="status-healthy">Healthy</div>
    </div>

    <div class="form-group">
      <label for="authToken">AUTH Token</label>
      <input type="text" id="authToken" placeholder="è¯·è¾“å…¥ AUTH Token">
    </div>

    <div class="button-group">
      <button onclick="calibrateToken()">æ ¡å‡† Token</button>
      <button onclick="getUserInfo()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
      <button onclick="getModels()">è·å–æ¨¡å‹åˆ—è¡¨</button>
    </div>

    <div class="form-group model-input-container">
      <label for="modelList">æ¨¡å‹åˆ—è¡¨</label>
      <input type="text" id="modelList" readonly>
      <button class="copy-button" onclick="copyModelList()">ğŸ“‹</button>
    </div>

    <div class="form-group custom-suffix">
      <input type="checkbox" id="customSuffix" onchange="toggleCustomSuffix()">
      <label for="customSuffix">æ·»åŠ è‡ªå®šä¹‰åç¼€</label>
      <input type="text" id="suffixInput" placeholder="@OpenAI" style="display: none;">
    </div>
  </div>

  <div id="userInfoContainer" class="container" style="display: none;">
    <h2>ç”¨æˆ·ä¿¡æ¯</h2>
    <div id="userDetails"></div>
    <div id="usageProgressContainer" class="progress-container"></div>
  </div>

  <div id="message"></div>

  <footer class="footer">
    <div id="version"></div>
    <div id="uptime"></div>
  </footer>

  <script>
    // å…¨å±€å˜é‡
    let globalModels = [];

    // Tokenæ ¡å‡†ç»“æœç¼“å­˜
    const calibrationCache = new Map();

    // æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
    async function checkServerStatus() {
      try {
        const response = await fetch('/health');
        const data = await response.json();

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        const statusElement = document.getElementById('serverStatus');
        statusElement.className = data.status === 'healthy' ? 'status-healthy' : 'status-error';
        statusElement.textContent = data.status === 'healthy' ? 'Healthy' : 'Error';

        // æ›´æ–°ç‰ˆæœ¬å’Œè¿è¡Œæ—¶é—´
        document.getElementById('version').textContent = `ç‰ˆæœ¬: ${data.version}`;
        document.getElementById('uptime').textContent = formatUptime(data.uptime);

        // ä¿å­˜æ¨¡å‹åˆ—è¡¨
        globalModels = data.models || [];

        return true;
      } catch (error) {
        const statusElement = document.getElementById('serverStatus');
        statusElement.className = 'status-error';
        statusElement.textContent = 'Error';
        showGlobalMessage('æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥å¤±è´¥', true);
        return false;
      }
    }

    // å®šæ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼ˆ5åˆ†é’Ÿï¼‰
    function startStatusCheck() {
      checkServerStatus();
      setInterval(checkServerStatus, 5 * 60 * 1000);
    }

    // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
    function formatUptime(seconds) {
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `è¿è¡Œæ—¶é—´: ${days}å¤© ${hours}æ—¶ ${minutes}åˆ†`;
    }

    // è·å–æ¨¡å‹åˆ—è¡¨
    async function getModels() {
      try {
        const modelList = document.getElementById('modelList');
        const suffix = document.getElementById('customSuffix').checked ?
          document.getElementById('suffixInput').value : '';

        modelList.value = globalModels.map(model => model + suffix).join(',');
        showGlobalMessage('æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°');
      } catch (error) {
        showGlobalMessage('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥', true);
      }
    }

    // å¤åˆ¶æ¨¡å‹åˆ—è¡¨
    function copyModelList() {
      const modelList = document.getElementById('modelList');
      navigator.clipboard.writeText(modelList.value)
        .then(() => showGlobalMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
        .catch(() => showGlobalMessage('å¤åˆ¶å¤±è´¥', true));
    }

    // åˆ‡æ¢è‡ªå®šä¹‰åç¼€è¾“å…¥æ¡†
    function toggleCustomSuffix() {
      const suffixInput = document.getElementById('suffixInput');
      suffixInput.style.display = document.getElementById('customSuffix').checked ? 'block' : 'none';
      if (document.getElementById('customSuffix').checked) {
        getModels();
      }
    }

    // Tokenç›¸å…³è¯·æ±‚
    async function makeTokenRequest(url, token) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token })
        });

        if (!response.ok) {
          throw new Error(`è¯·æ±‚å¤±è´¥ (${response.status})`);
        }

        return await response.json();
      } catch (error) {
        showGlobalMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, true);
        return null;
      }
    }

    // Token æ ¡å‡†
    async function calibrateToken() {
      const token = document.getElementById('authToken').value;
      if (!token) {
        showGlobalMessage('è¯·è¾“å…¥ AUTH Token', true);
        return;
      }
      const result = await makeTokenRequest('/basic-calibration', token);
      if (result) {
        if (result.status === 'error') {
          showGlobalMessage(result.message, true);
        } else {
          showGlobalMessage('æ ¡å‡†æˆåŠŸ');
          // ç¼“å­˜æ ¡å‡†ç»“æœ
          calibrationCache.set(token, {
            user_id: result.user_id,
            create_at: result.create_at,
            checksum_time: result.checksum_time
          });

          // æ˜¾ç¤ºåŸºæœ¬æ ¡å‡†ä¿¡æ¯
          const container = document.getElementById('userInfoContainer');
          container.style.display = 'block';
          updateUsageDisplay({ user: null }, calibrationCache.get(token));
        }
      }
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯
    async function getUserInfo() {
      const token = document.getElementById('authToken').value;
      if (!token) {
        showGlobalMessage('è¯·è¾“å…¥ Token', true);
        return;
      }

      // å¦‚æœæ²¡æœ‰æ ¡å‡†ç¼“å­˜ï¼Œå…ˆè¿›è¡Œæ ¡å‡†
      if (!calibrationCache.has(token)) {
        showGlobalMessage('æ­£åœ¨è¿›è¡Œ Token æ ¡å‡†...');
        await calibrateToken();
        if (!calibrationCache.has(token)) {
          return; // å¦‚æœæ ¡å‡†å¤±è´¥ï¼Œç›´æ¥è¿”å›
        }
      }

      const result = await makeTokenRequest('/userinfo', token);
      if (result) {
        const container = document.getElementById('userInfoContainer');
        container.style.display = 'block';
        updateUsageDisplay(result, calibrationCache.get(token));
        showGlobalMessage('ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ');
      }
    }

    // æ›´æ–°ä½¿ç”¨æƒ…å†µæ˜¾ç¤º
    function updateUsageDisplay(tokenInfo, calibInfo) {
      const userDetails = document.getElementById('userDetails');
      const progressContainer = document.getElementById('usageProgressContainer');

      // æ¸…ç©ºç°æœ‰å†…å®¹
      userDetails.innerHTML = '';
      progressContainer.innerHTML = '';

      // æ·»åŠ ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
      if (tokenInfo.user || calibInfo) {
        const user = tokenInfo.user || {};
        userDetails.innerHTML += `<p>ç”¨æˆ·ID: ${calibInfo ? calibInfo.user_id : user.id}</p><p>é‚®ç®±: ${user.email || ''}</p><p>ç”¨æˆ·å: ${user.name || ''}</p>${user.updated_at ? `<p>æ›´æ–°æ—¶é—´: ${new Date(user.updated_at).toLocaleString()}</p>` : ''}${calibInfo ? `<p>ä»¤ç‰Œåˆ›å»ºæ—¶é—´: ${new Date(calibInfo.create_at).toLocaleString()}</p>` : ''}${calibInfo && calibInfo.checksum_time ? `<p>æ ¡éªŒå’Œæ—¶é—´åŒºé—´: ${new Date(calibInfo.checksum_time * 1e6).toLocaleString()} - ${new Date((calibInfo.checksum_time + 1) * 1e6 - 1).toLocaleString()}</p>` : ''}`;
      }

      // æ·»åŠ  Stripe ä¼šå‘˜ä¿¡æ¯
      if (tokenInfo.stripe) {
        const stripe = tokenInfo.stripe;
        userDetails.innerHTML += `<p>ä¼šå‘˜ç±»å‹: ${stripe.membership_type}</p>${stripe.payment_id ? `<p>ä»˜æ¬¾ ID: ${stripe.payment_id}</p>` : ''}<p>è¯•ç”¨å‰©ä½™: ${stripe.days_remaining_on_trial} å¤©</p>`;
      }

      // æ·»åŠ ä½¿ç”¨æƒ…å†µè¿›åº¦æ¡
      if (tokenInfo.usage) {
        const usage = tokenInfo.usage;
        const models = {
          'é«˜çº§æ¨¡å‹': usage.premium,
          'æ ‡å‡†æ¨¡å‹': usage.standard,
          'æœªçŸ¥æ¨¡å‹': usage.unknown
        };

        Object.entries(models).forEach(([modelName, data]) => {
          if (data) {
            const isUnlimited = !data.max_requests;
            const percentage = isUnlimited ? 100 : (data.requests / data.max_requests * 100).toFixed(1);
            const progressClass = isUnlimited ? 'unlimited' : getProgressBarClass(parseFloat(percentage));

            progressContainer.innerHTML += `<div><p>${modelName}: ${data.requests}/${isUnlimited ? 'âˆ' : data.max_requests} è¯·æ±‚ ${isUnlimited ? '' : `(${percentage}%)`}, ${data.tokens} tokens</p><div class="usage-progress-container"><div class="usage-progress-bar ${progressClass}" style="width: ${percentage}%"></div></div></div>`;
          }
        });
      }
    }

    // è·å–è¿›åº¦æ¡æ ·å¼
    function getProgressBarClass(percentage) {
      if (percentage < 50) return 'progress-low';
      if (percentage < 80) return 'progress-medium';
      return 'progress-high';
    }

    // Tokenå˜æ›´æ—¶æ¸…é™¤ç¼“å­˜
    document.getElementById('authToken').addEventListener('change', (e) => {
      calibrationCache.delete(e.target.value); // æ¸…é™¤å¯¹åº”çš„ç¼“å­˜
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await startStatusCheck();
        showGlobalMessage('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

        // ç›‘å¬åç¼€è¾“å…¥å˜åŒ–
        document.getElementById('suffixInput').addEventListener('input', getModels);
      } catch (error) {
        showGlobalMessage('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥', true);
      }
    });
  </script>
</body>

</html>